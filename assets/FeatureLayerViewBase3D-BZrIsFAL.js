const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Feature3DPipeline-DHD72QYX.js","assets/index-B9VIL3e7.js","assets/index-ClKQjglF.css","assets/AttributeBinsFeatureSet-DM6oi3MD.js","assets/utils-CpC53IHB.js","assets/LodRenderer-Hl7f55gC.js","assets/highlightUtils-SxJxFtFI.js","assets/HeatmapDensity.glsl-BUrEf9uy.js","assets/timeSupport-D2E-ODX-.js","assets/utils-BJyoDuBg.js","assets/AttributeBinsQuery-C8bs576d.js","assets/FixedIntervalBinParameters-BOwLvkEd.js","assets/attributeUtils-Dc8--CBJ.js","assets/highlightOptionsUtils-C0_HBi6j.js","assets/FeatureTileDescriptor-DN6b7o_3.js","assets/dehydratedFeatureComparison-hlb-Kvb3.js","assets/queryForSymbologySnapping-D9ytzwKz.js","assets/Graphics3DFeatureProcessor-CQ0Y-Z4c.js","assets/hash-CcEbRgUF.js","assets/renderingInfoUtils-CnGaY-67.js","assets/ExtentSet-BCIkI9u7.js","assets/optimizedFeatureQueryEngineAdapter-CeVNkbcZ.js","assets/Graphics3DObjectStates-_g2NNqfA.js","assets/QueryEngine-BMYA_PjF.js","assets/WhereClauseCache-DlYsviOV.js","assets/WhereClause-pdVwMjDR.js","assets/QueryEngineCapabilities-DJC_YILC.js","assets/utils-DJVbhSCc.js","assets/utils-1zpflrmn.js","assets/ClassBreaksDefinition-B0Os_EsO.js","assets/SnappingCandidate-DGkpYqI6.js","assets/FeatureStore-Bib0_bTV.js","assets/BoundsStore-BQRWsyLF.js","assets/LayerView3D-CvglZQJN.js","assets/query-DE-K6EKB.js","assets/pbfQueryUtils-BqJL2bSP.js","assets/pbf-CU5GU1Du.js","assets/EventedSet-BJsMF-Fw.js","assets/FeatureIdInfo-iL5WjyEH.js","assets/constants-SxxbBSOD.js","assets/LayerView-D9_Pl3yT.js","assets/RefreshableLayerView-B3uUNyfN.js"])))=>i.map(i=>d[i]);
import{bH as j,V as $,bp as Z,hX as G,cb as A,a9 as P,qT as z,c as q,a6 as U,tw as H,ap as C,e as a,m as n,h as b,an as R,tx as B,k as T,ar as M,cQ as J,ty as W,tz as K,dT as X,bP as O,pF as D,dy as Y,tA as ee,tB as te,tC as re,bl as v,tD as ie,bw as S,iO as E,dO as N,tE as se,dx as ae,tF as le,pG as Q,tG as ne,pH as L,tH as oe,tI as ue,s4 as m,tJ as pe,tK as de,tL as x,bg as ce,tM as he,dz as ye,tN as fe,bn as me,_ as ge,tO as Fe,s as be,bD as we}from"./index-B9VIL3e7.js";import{V as xe,L as _e,v as ve}from"./HeatmapDensity.glsl-BUrEf9uy.js";import{l as Ie}from"./LayerView3D-CvglZQJN.js";import{j as Re,y as Ce}from"./query-DE-K6EKB.js";import{s as Oe}from"./EventedSet-BJsMF-Fw.js";import{e as Ee}from"./FeatureIdInfo-iL5WjyEH.js";import{E as qe}from"./constants-SxxbBSOD.js";import{a as Pe}from"./Graphics3DFeatureProcessor-CQ0Y-Z4c.js";import{d as Me}from"./LayerView-D9_Pl3yT.js";import{i as Ve}from"./RefreshableLayerView-B3uUNyfN.js";let $e=class extends j{constructor(e,i,r,s,l,u){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=i,this.totalVertices=r,this.partial=s,this.mode=l,this.symbolComplexity=u}};class Te{constructor(e){this._controller=e,this._handle=new Se(i=>e.schedule(i))}destroy(){this._handle.destroy()}invoke(e,i){return e.buffer&&e.buffer.byteLength!==0?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof $&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,i).then(r=>{let s=0,l=0;const u=$.fromJSON(r.spatialReference);r.spatialReference=u;const p=async d=>{const o=r.fields;if(o){for(;s<o.length;)if(o[s]=Z.fromJSON(o[s]),s++,d.madeProgress())return this._controller.reschedule(F=>p(F))}const h=r.features;for(;l<h.length;){const F=h[l];++l,F.uid=G();const w=F.geometry;if(w!=null&&(w.spatialReference=u,De(w),d.madeProgress()))return this._controller.reschedule(c=>p(c))}return r};return this._controller.schedule(d=>p(d))})):Promise.resolve(null)}}function De(t){switch(t.type){case"polyline":t.paths=t.hasZ&&t.hasM?t.paths.map(e=>e.map(i=>[i[0],i[1],i[2],i[3]])):t.hasZ||t.hasM?t.paths.map(e=>e.map(i=>[i[0],i[1],i[2]])):t.paths.map(e=>e.map(i=>[i[0],i[1]]));break;case"polygon":t.rings=t.hasZ&&t.hasM?t.rings.map(e=>e.map(i=>[i[0],i[1],i[2],i[3]])):t.hasZ||t.hasM?t.rings.map(e=>e.map(i=>[i[0],i[1],i[2]])):t.rings.map(e=>e.map(i=>[i[0],i[1]]))}}class Se extends A{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:i=>[i.buffer]},e)}}let g=class extends P{constructor(t){super(t)}get implicitFields(){if(!this.layer.outFields?.includes("*"))return new Set;const e=new Set(this.layerView.requiredFields),i=new Set(this.layerView.availableFields);return z(i,e)}get queryFeaturesDehydrated(){const{layer:t}=this,e=t.capabilities,i=e&&e.query,r=i&&i.supportsFormatPBF,s=t.parsedUrl;if(r){this._decoder==null&&(this._decoder=new Te(this.controller));const l={sourceSpatialReference:t.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:k};return(u,p)=>Re(s,u,"pbf",this._createRequestOptions(p)).then(d=>(q(p),this._decoder!=null?this._decoder.invoke({buffer:d.data,options:l},p.signal):Promise.reject(U())))}return(l,u)=>Ce(s,l,t.spatialReference,this._createRequestOptions(u)).then(p=>H(p.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:k}))}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}destroy(){this._decoder=C(this._decoder)}_createRequestOptions(t){return{...t,query:{...this.layer.customParameters,token:this.layer.apiKey,...t?.query}}}};a([n({constructOnly:!0})],g.prototype,"layer",void 0),a([n({constructOnly:!0})],g.prototype,"layerView",void 0),a([n({constructOnly:!0})],g.prototype,"controller",void 0),a([n({readOnly:!0})],g.prototype,"implicitFields",null),a([n({readOnly:!0})],g.prototype,"queryFeaturesDehydrated",null),g=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],g);let I=class extends P{constructor(e){super(e)}queryFeaturesDehydrated(e,i){return this.layer.queryFeatures(e,i)}};a([n({constructOnly:!0})],I.prototype,"layer",void 0),I=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],I);let _=class extends P{constructor(t){super(t)}queryFeaturesDehydrated(t,e){return this.source.queryFeaturesJSON(t,e).then(H,i=>{if(i&&i.name==="query-features-json:unsupported")return this.layer.queryFeatures(t,e);throw i})}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}};function Ne(t,e){const{layer:i}=t;return i.type==="feature"&&i.source.type==="feature-layer"||i.type==="catalog-footprint"?new g({layer:i,layerView:t,controller:e}):i.type==="feature"&&i.source.type==="memory"||i.type==="csv"||i.type==="geojson"||i.type==="oriented-imagery"||i.type==="wfs"?new _({layer:i,source:i.source}):i.type==="ogc-feature"?new I({layer:i}):null}a([n({constructOnly:!0})],_.prototype,"layer",void 0),a([n({constructOnly:!0})],_.prototype,"source",void 0),_=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],_);const k=1024;class Qe{constructor(e){this._memoryCache=null;const i=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=i.objectIdField,this.globalIdField="globalIdField"in i?i.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const r=this._layerView.view.resourceController;this.query=Ne(this._layerView,r.normal),r&&this._memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(`fl-${i.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=C(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFieldsForQuery,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme?.spatialReference??this._layerView.view.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles?.tilingScheme}get scheduler(){return this._layerView.view.resourceController?.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){return this._layerView.layer.elevationInfo?.mode==="on-the-ground"}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get highlightIds(){return this._layerView.displayFilterEnabled?this._layerView.highlightIds:null}get capabilities(){return this._capabilities??=Le(this._layerView.layer),this._capabilities}logFetchError(e,i){e.error("#fetchTile()",this._layerView.layer,i?.message??i)}}function Le(t){const e=t.capabilities.query;return{supportsMultipleResolutions:ke(t),supportsPagination:!(!e||!e.supportsPagination),supportsResultType:!(!e||!e.supportsResultType),supportsCacheHint:!(!e||!e.supportsCacheHint),supportsQuantization:!(!e||!e.supportsQuantization),supportsQuantizationEditMode:!(!e||!e.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!e||!e.supportsMaxRecordCountFactor),supportsFormatPBF:!(!e||!e.supportsFormatPBF)}}function ke(t){switch(t.geometryType){case"polyline":return!0;case"polygon":return t.capabilities&&t.capabilities.query&&t.capabilities.query.supportsQuantization;default:return!1}}let y=class extends xe{constructor(t){super(t),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(R(()=>({controller:this.controller,suspended:this.suspended}),({controller:t,suspended:e})=>{t&&!e&&this._needsRefresh&&(t.refetch(),this._needsRefresh=!1)}))}destroy(){this._fetcherContext=C(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(t){this._set("maximumNumberOfFeatures",t),this.controller&&(this.controller.maximumNumberOfFeatures=t)}get snappingComplexityExceeded(){return this.controller?.snappingComplexityExceeded??!0}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let t=0;if(this.controller?.updating){const i=this.controller.updatingRemaining,r=Math.max(this.controller.updatingTotal,this._controllerTotal);r>0&&(t=(r-i)/r,this._controllerTotal=r)}let e=0;if(this.processor?.updating){const i=this.processor.updatingRemaining,r=Math.max(i,this._processorTotal);r>0&&(e=(r-i)/r,this._processorTotal=r)}return .5*(t+e)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const t=He.get(this.layer.geometryType);return t==null||this.controller.serviceDataCount>t?0:1}case"tiles":return 0}}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const t=this.processor?.unprocessedMemoryEstimate??0,e=this.controller?.expectedFeatureDiff??0,i=this.processor?.loadedFeatures??0,r=i+e>0?i/(i+e):1;return t+e*(this.processor?.usedMemoryPerFeature??0)*r}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){const t=this.controller?.displayFeatureLimit,e=t?.averageSymbolComplexity,i=e!=null?`f:${e.verticesPerFeature},v:${e.verticesPerCoordinate}`:"n/a";return new $e(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",i)}async doRefresh(t){const{controller:e,processor:i,suspended:r}=this;t&&e&&(r?this._needsRefresh=!0:(e.refetch(),this._needsRefresh=!1)),i.refreshFilter()}setVisibility(t,e){this.processor?.setObjectIdVisibility(t,e)}getMissingAttributesForFeature(t){return this.controller.getMissingAttributesForFeature(t)}getHydratedGeometry(t){const e=this.graphics3DProcessor;if(e==null)return null;const i=e.graphics3DGraphicsByObjectID;if(i==null)return null;const r=i.get(t);return r==null?null:B(r.graphic.geometry)}createController(){this._fetcherContext=new Qe({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const t=new _e({layerView:this.layerView,context:this._fetcherContext,graphics:new Oe,extent:this.clippingExtent});return this.updatingHandles.add(()=>t.serviceDataExtent,e=>{this.processor&&(this.processor.dataExtent=e)},T),this.addHandles(R(()=>this.suspended&&this.layerView.updateSuspended,e=>{e?t.suspend():t.resume()},M)),this.updatingHandles.add(()=>this.processor?.displayFeatureLimit,e=>t.displayFeatureLimit=e,T),this.addHandles(J(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),t}beforeSetController(t){t.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}};a([n()],y.prototype,"layerView",void 0),a([n()],y.prototype,"controller",void 0),a([n()],y.prototype,"_controllerTotal",void 0),a([n()],y.prototype,"_processorTotal",void 0),a([n()],y.prototype,"_needsRefresh",void 0),a([n()],y.prototype,"maximumNumberOfFeatures",null),a([n()],y.prototype,"snappingComplexityExceeded",null),a([n()],y.prototype,"maximumNumberOfFeaturesExceeded",null),a([n()],y.prototype,"updatingProgressValue",null),a([n()],y.prototype,"updatePolicy",null),a([n()],y.prototype,"suspendResumeExtentMode",void 0),y=a([b("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],y);const He=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);function je(t,e){if(e.type!=="feature"&&e.type!=="subtype-group")return[];if(!e.url)return[];const i="utilityNetworks"in t.map?t.map.utilityNetworks??[]:[];for(const r of i)if(r.isUtilityLayer(e)){const s=e.fieldsIndex.get("assetgroup"),l=e.fieldsIndex.get("assettype");return[s?.name,l?.name].filter(u=>u!=null)}return[]}class Ze{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(e=>e.currentUserRequired)}}visitClientWhereClause(e){e&&this._clauses.push(W(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,i){if(e&&i!=null)for(const r of i)this.visitClientWhereClause(r.where)}visitDisplayFilter(e,i){if(e)for(const r of i?.filters??[])this.visitClientWhereClause(r.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){e!=null&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}}const Ge=t=>{const e=t;let i=class extends e{constructor(...r){super(...r),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([R(()=>{const r=this.layer,s=this.view;return[r&&"elevationInfo"in r?r.elevationInfo?.featureExpressionInfo:null,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,s?.requiredFieldsOptions?.featureTitleFields&&r&&"featureTitleFields"in r&&r.featureTitleFields,s?.requiredFieldsOptions?.utilityNetworkFields&&je(s,r),r.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,r?.type==="knowledge-graph-sublayer"&&r.parentCompositeLayer.type==="link-chart"&&r.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode]},()=>this._handleChange(),M),O(()=>this.view?.floors,"change",()=>this._handleChange()),O(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),O(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:r,layer:{fieldsIndex:s},requiredFields:l}=this;return"outFields"in r&&r.outFields?D(s,[...Y(s,r.outFields),...l]):D(s,l)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const r=this.layer;return this.displayFilterEnabled&&r.displayFilterInfo?ee(r.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const r=this.effectiveDisplayFilter?.where??null;return r&&this.hasHighlight?te(r,re(this.layer.objectIdField,this.highlightIds)):r}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){v.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?ie(this.layer.url):Promise.resolve(null)}highlight(r,s){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=this.filter!=null?this.filter.createQuery(r):new S(r);return"floorInfo"in this.layer&&this.layer.floorInfo&&(s.where=E(s.where,N(this))),this.displayFilterEnabled&&(s.where=E(s.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(s.timeExtent=s.timeExtent!=null?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new S(r)}queryFeatures(r,s){throw new Error("missing implementation")}queryObjectIds(r,s){throw new Error("missing implementation")}queryFeatureCount(r,s){throw new Error("missing implementation")}queryExtent(r,s){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(r,s){const l=[],u=new Set;for(const d of r){const o=se(d.origin),h=ae(o,{...s,checkPopupEnabled:!0});h&&(l.push(d),u.add(h))}if(l.length===0||u.size===0)return[];const p=await this._createPopupQuery(u,s);return await le(this.layer,l,p,{hasRequiredFields:(d,o)=>this._popupFeatureHasRequiredFields(d,o),...s})}_handleChange(){const r=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",r),r.then(()=>{this._updatingRequiredPromise===r&&this._set("_updatingRequiredPromise",null)}),r}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:r}=this,s=new Ze(r.fieldsIndex);if(s.visitFilter(this.filter),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction),"labelingInfo"in r&&s.visitLabelingInfo(r.labelsVisible,r.labelingInfo),"trackInfo"in r&&s.visitTrackInfo(r.trackInfo),this.view.type==="2d"&&(s.visitFilter(this.featureEffect?.filter),s.visitDisplayFilter(this.displayFilterEnabled,r.displayFilterInfo),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction)),r.type==="subtype-group")for(const l of r.sublayers)s.visitLabelingInfo(l.labelsVisible,l.labelingInfo);try{const l=await s.finish();this._set("requiresCurrentUser",l.requiresCurrentUser)}catch(l){v.getLogger(this).error(l)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const r=this.view.type==="3d",{layer:s,layer:{fieldsIndex:l}}=this,u="renderer"in s&&s.renderer,p="orderBy"in s&&s.orderBy,d="featureReduction"in s?s.featureReduction:null,o=new Set,h=[u?u.collectRequiredFields(o,l):null,Q(o,s),r&&"elevationInfo"in s?ne(o,s):null,this.filter!=null?L(o,s,this.filter):null,r||this.featureEffect==null?null:L(o,s,this.featureEffect.filter),!r&&d?oe(o,s,d):null,!r&&p?ue(o,s,p):null];if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&m(o,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"timeInfo"in s&&s.timeInfo&&"trackInfo"in s&&s.trackInfo){const{trackInfo:c}=s;m(o,s.fieldsIndex,[s.timeInfo.trackIdField]),s.type!=="feature"&&c.timeField!=="startTimeField"||m(o,s.fieldsIndex,[s.timeInfo.startField]),c.timeField==="endTimeField"&&m(o,s.fieldsIndex,[s.timeInfo.endField]),await pe(o,s)}if("floorInfo"in s&&s.floorInfo&&m(o,s.fieldsIndex,[s.floorInfo.floorField]),"featureTitleFields"in s&&this.view?.requiredFieldsOptions?.featureTitleFields&&s.featureTitleFields&&m(o,s.fieldsIndex,s.featureTitleFields),s.type==="feature"&&s.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&m(o,s.fieldsIndex,[s.globalIdField]),this.displayFilterEnabled&&h.push(de(o,s,s.displayFilterInfo)),s.type==="feature"&&r&&s.infoFor3D!=null&&(s.globalIdField==null&&v.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),m(o,s.fieldsIndex,[s.globalIdField])),s.type==="subtype-group"){x(o,l,s.subtypeField);const c=s.sublayers.map(V=>Promise.all([V.renderer?.collectRequiredFields(o,l),Q(o,V)]));h.push(Promise.all(c))}if(s.type==="catalog-footprint"&&s.parent){const c=s.parent;m(o,l,[c.itemNameField,c.itemSourceField,c.itemTypeField,c.maxScaleField,c.minScaleField])}s.type==="knowledge-graph-sublayer"&&s.parentCompositeLayer.type==="link-chart"&&x(o,l,qe);const F=await Promise.allSettled(h);if(r)x(o,l,s.objectIdField);else for(const c of Ee(Pe(s)))x(o,l,c);r&&"displayField"in s&&s.displayField&&x(o,l,s.displayField);for(const c of F)c.status==="rejected"&&v.getLogger(this).error(c.reason);const w=Array.from(o).sort();this._set("requiredFields",w)}_popupFeatureHasRequiredFields(r,s){return ce(r,s)}async _createPopupQuery(r,s){const l=this.layer.createQuery(),u=new Set;let p=this.layer.geometryType==="point";for(const d of r){if(!p){const h=await he(d);q(s),p=(h&&h.arcadeUtils.hasGeometryOperations(d))??!1}const o=await ye(this.layer,d);q(s);for(const h of o)u.add(h)}return l.returnGeometry=p,l.returnZ=p,l.returnM=p,l.outFields=Array.from(u),l.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(l.where=E(l.where,N(this))),l}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return a([n()],i.prototype,"_updatingRequiredPromise",void 0),a([n({readOnly:!0})],i.prototype,"availableFields",null),a([n({readOnly:!0})],i.prototype,"displayFilterEnabled",null),a([n({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),a([n({readOnly:!0})],i.prototype,"effectiveDisplayFilterClause",null),a([n({type:K})],i.prototype,"featureEffect",null),a([n({type:X})],i.prototype,"filter",void 0),a([n()],i.prototype,"layer",void 0),a([n({type:Number})],i.prototype,"maximumNumberOfFeatures",null),a([n({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),a([n()],i.prototype,"requiresCurrentUser",void 0),a([n({readOnly:!0})],i.prototype,"requiredFields",void 0),a([n({readOnly:!0})],i.prototype,"signedInUser",null),a([n()],i.prototype,"suspended",void 0),a([n()],i.prototype,"view",void 0),i=a([b("esri.views.layers.FeatureLayerView")],i),i};let f=class extends Ve(ve(Ge(Ie(Me)))){constructor(t){super(t)}initialize(){this.addHandles(R(()=>this._updatingRequiredPromise,t=>this._updatingHandles.addPromise(t),M))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=C(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(t){this.graphicsPipeline.maximumNumberOfFeatures=t}get maximumNumberOfFeaturesExceeded(){return this.graphicsPipeline!=null&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??0}get snappingComplexityExceeded(){return this.graphicsPipeline?.snappingComplexityExceeded??!0}get hasZ(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsZ)&&("returnZ"in t&&t.returnZ!=null?t.returnZ:e.supportsZ)}get hasM(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsM)&&"returnM"in t&&t.returnM!=null&&t.returnM}get availableFieldsForQuery(){return fe(this.layer.fieldsIndex,this.availableFields)}setVisibility(t,e){this.graphicsPipeline?.setVisibility(t,e)}createQuery(){return super.createQuery()}queryFeatures(t,e){const i=()=>super.queryFeatures(t,e);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(t),i):i()}async createGraphicsPipeline(){if(me("feature-pipeline-3d-test")){const{Feature3DPipeline:t}=await ge(()=>import("./Feature3DPipeline-DHD72QYX.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41]));return new t({layerView:this})}return new y({layerView:this})}async doRefresh(t){return await this.graphicsPipeline.doRefresh(t)}_popupFeatureHasRequiredFields(t,e){if(!super._popupFeatureHasRequiredFields(t,e))return!1;const i=Fe(t,this.layer.objectIdField);if(i==null)return!0;const r=this.graphicsPipeline.getMissingAttributesForFeature(i);if(r==null)return!0;for(const s of e)if(r.has(s))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(t,e){this._validateQueryFeaturesMesh(t);const i=await e(),r=this.graphicsPipeline;if(t?.outStatistics||r==null)return i;const s=this.layer.objectIdField,l=[];for(const u of i.features)if(u.geometry){const p=r.getHydratedGeometry(u.attributes[s]);p&&(u.geometry=p,l.push(u))}else l.push(u);return i.features=l,i}_validateQueryFeaturesMesh(t){if(!t)return;const e=r=>{throw new be("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${r}'`)},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)t[r]!=null&&e(r);"returnM"in t&&t.returnM&&e("returnM"),"returnCentroid"in t&&t.returnCentroid&&e("returnCentroid"),t.outSpatialReference==null||t.outSpatialReference.equals(this.view.spatialReference)||e("outSpatialReference")}get test(){}};a([n()],f.prototype,"layer",void 0),a([n()],f.prototype,"graphicsPipeline",void 0),a([n()],f.prototype,"maximumNumberOfFeatures",null),a([n()],f.prototype,"maximumNumberOfFeaturesExceeded",null),a([n(we)],f.prototype,"updatingProgress",void 0),a([n({readOnly:!0})],f.prototype,"updatingProgressValue",null),a([n({readOnly:!0})],f.prototype,"updatePolicy",null),a([n()],f.prototype,"snappingComplexityExceeded",null),a([n({readOnly:!0})],f.prototype,"hasZ",null),a([n({readOnly:!0})],f.prototype,"hasM",null),a([n()],f.prototype,"availableFieldsForQuery",null),f=a([b("esri.views.3d.layers.FeatureLayerViewBase3D")],f);export{f,$e as t};

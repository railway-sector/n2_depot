import{an as S,ao as v,pJ as W,pK as J,e as m,m as p,h as L,pL as U,pM as P,pN as D,pO as G,pP as M,pQ as g,pR as Z,s as j,dx as Q,ab as Y,bB as K,pS as X,pT as ee}from"./index-B9VIL3e7.js";import{v as te,u as F,I as re}from"./rasterProjectionHelper-C71OE4Dv.js";import{l as ie}from"./LayerView3D-CvglZQJN.js";import{p as se}from"./TiledLayerView3D-DctoaFpl.js";import{l as ae}from"./throttle-CPt9ZDCr.js";import{y as le}from"./dataUtils-CgGi9ege.js";import{r as ne,c as oe}from"./FlowSubView3D-DSq5ODVM.js";import{h as b,c as ue}from"./loadUtils-BUCniI8z.js";import{V as he,i as w,a as de}from"./rasterFieldUtils-D6Nxj3z9.js";import{i as me}from"./timeSupport-D2E-ODX-.js";import{t as pe}from"./datasetUtils-DdDUWBI2.js";import{d as ce}from"./LayerView-D9_Pl3yT.js";import{i as fe}from"./RefreshableLayerView-B3uUNyfN.js";import"./SubView3D-C8cM8MqG.js";import"./line-BhTYkV4Y.js";import"./FeatureTileDescriptor-DN6b7o_3.js";import"./utils-BJyoDuBg.js";const _={type:"delete"},ye={type:"waiting"},ge={type:"on-worker",upsampled:!1},_e={type:"on-worker",upsampled:!0};let I=class extends ne{constructor(t){super(t),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:t,layerIndex:e,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(t))&&e===this._layerIndex&&r===1&&this._updateFlowDataTile(t)}),S(()=>this.renderedTiles,t=>{const e=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(t,r));this.updatingHandles.addPromise(e)},v),S(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},v)]),this._throttledTriggerLoad=ae(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,oe,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(t,e){const r=z();for(const i of t??[]){const a=this._flowDataTiles?.get(b(i)),s=a==null||a.type==="delete"||a.type==="waiting"?this._getLoadedState(i):a;s!=null&&r.set(b(i),s),e.madeProgress(),e.done&&(e=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:t}=this;this._allTilesLoaded?(t.hasPendingUpdates()||t(),t.forceUpdate()):t()}async fetchDataAndGenerateStreamlines(t,e){const{_flowDataTiles:r,needsMagnitude:i,workerHandle:a}=this,s=this.getSimulationSettings(t);if(s==null||a==null||r==null)return;const o=this._resetTileData;this._resetTileData=!1;const h=z();r.forEach((l,n)=>{l.type==="delete"?(h.set(n,_),r.delete(n)):(o||l.type!=="on-worker"&&l.type!=="waiting")&&(h.set(n,l),r.set(n,l.type!=="waiting"&&l.upsampled?_e:ge))});const u={simulationSettings:s,flowExtentInfo:t.flowExtentInfo,flowDataTiles:h,reset:o,needsMagnitude:i,startPositions:this.startPositions(t)},{streamlines:d}=await a.generateTiledStreamlines(u,e);return d}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(t){const{_layerIndex:e}=this,r=t.surface==null;if(e==null||r)return _;const i=t.getLayerInfo(e,1);if(i==null)return _;if(!t.visible&&i.requestAbort==null)return i.requestAbort=new AbortController,this.surface.requestTileData(t,e,1,i.requestAbort),_;const a=this._getRasterTile(i,t,e);return a==null?this._upsampleFlowData(e,i.upsampleInfo,t.lij,t.extent):{type:"loaded",data:this._createFlowDataTile(a,t.lij,t.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(t,e,r,i){if(e==null)return _;const a=e.tile;if(a==null)return _;const s=a.getLayerInfo(t,1);if(s==null)return _;const o=this._getRasterTile(s,a,t);if(o==null)return _;const{scale:h,offset:u}=e,d=Math.max(Math.floor(this._pixelSize*h),1),l=o.source,n=Math.floor(u[0]*l.width),y=Math.floor((1-u[1]-h)*l.height);return{type:"loaded",data:this._createFlowDataTile(o,r,i,d,n,y),upsampled:!0}}_getRasterTile(t,e,r){const{data:i}=t;return!t.dataMissing&&e.hasLayerData(r,1)&&W(i)?i:null}_createFlowDataTile(t,e,r,i,a,s){const o=le(this.layer.serviceRasterInfo.dataType,t.source,i,i,a,s),h=o.mask.slice();return new ue(o.data,h,o.width,o.height,e,J(r))}_updateFlowDataTile(t){const{renderedTiles:e,_layerIndex:r}=this;if(e==null||r==null)return;if(e.has(t)){const a=this._getLoadedState(t);return void(this._setTileData(t,a)&&this.triggerLoad())}let i=this._setTileData(t,_);for(const a of e.values()){const s=a.getLayerInfo(r,1);if(s==null||this._getRasterTile(s,a,r)!=null||s.upsampleInfo?.tile!==t)continue;const h=this._getLoadedState(a),u=this._setTileData(a,h);i||=u}i&&this.triggerLoad()}_setTileData(t,e){const{_flowDataTiles:r}=this;if(r==null)return!1;const i=b(t);return(r.get(i)!=null||e.type!=="delete")&&(r.set(i,e),!0)}get _allTilesLoaded(){let t=0;for(const e of this._flowDataTiles?.values()??[])e.type!=="delete"&&e.type!=="waiting"&&t++;return t===this.renderedTiles?.size}invalidateTileData(){const{_flowDataTiles:t}=this;t?.forEach((e,r)=>{t.set(r,ye)})}_tileIsUpsampled(t){const e=this._flowDataTiles?.get(b(t));return e!=null&&(e.type==="loaded"||e.type==="on-worker")&&e.upsampled}get usedMemory(){const t=9*this._pixelSize**2,e=(this._flowDataTiles?.size??0)*t;return super.usedMemory+e}get test(){return{...super.test,loadedTiles:this._flowDataTiles??z()}}};function z(){return new Map}m([p()],I.prototype,"_throttling",void 0),I=m([L("esri.views.3d.support.flow.FlowSubViewTiles3D")],I);function Te(t,e,r="nearest",i=!1){const a=!(i&&e.pixelType==="u8"),s=a?D.FLOAT:D.UNSIGNED_BYTE,o=e.pixels==null||e.pixels.length===0?null:a?e.getAsRGBAFloat():e.getAsRGBA(),h=t.capabilities.textureFloatLinear,u=new P(e.width,e.height);return u.internalFormat=a?U.RGBA32F:6408,u.samplingMode=!h||r!=="bilinear"&&r!=="cubic"?9728:9729,u.dataType=s,u.wrapMode=33071,new G(t,u,o)}function we(t,e){const{spacing:r,offsets:i,coefficients:a,size:[s,o]}=e,h=r[0]>1,u=new P(h?4*s:s,o);u.internalFormat=U.RGBA32F,u.dataType=D.FLOAT,u.samplingMode=9728,u.wrapMode=33071;const d=new Float32Array(h?s*o*16:2*i.length);if(h&&a!=null)for(let l=0,n=0;l<a.length;l++)d[n++]=a[l],l%3==2&&(d[n++]=1);else for(let l=0;l<o;l++)for(let n=0;n<s;n++){const y=4*(l*s+n),c=2*(n*o+l);d[y]=i[c],d[y+1]=i[c+1],d[y+3]=i[c]===-1?0:1}return new G(t,u,d)}function C(t,e){const r=new P(e.length/4,1);return r.internalFormat=6408,r.samplingMode=9728,r.wrapMode=33071,new G(t,r,e)}function xe(t,e,r,i=1,a=!0){return{u_flipY:a,u_applyTransform:!!t,u_opacity:i,u_transformSpacing:t?t.spacing:M,u_transformGridSize:t?t.size:M,u_targetImageSize:e,u_srcImageSize:r}}function be(t,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:t?t.length/4-1:0}}function Ie(t){return{u_bandCount:t.bandCount,u_minOutput:t.minOutput,u_maxOutput:t.maxOutput,u_minCutOff:t.minCutOff,u_maxCutOff:t.maxCutOff,u_factor:t.factor,u_useGamma:t.useGamma,u_gamma:t.gamma,u_gammaCorrection:t.gammaCorrection}}function Se(t){return{u_hillshadeType:t.hillshadeType,u_sinZcosAs:t.sinZcosAs,u_sinZsinAs:t.sinZsinAs,u_cosZs:t.cosZs,u_weights:t.weights,u_factor:t.factor,u_minValue:t.minValue,u_maxValue:t.maxValue}}const $={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ve{constructor(e,r,i=null,a=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=i||r.width,this.height=a||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=g(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...$,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||$}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((r,i)=>!!this._bandIds?.[i]&&r===this._bandIds[i])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=g(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=we(e,this.transformGrid))),!0)}getUniforms(e){const{symbolizerParameters:r,transformGrid:i,width:a,height:s,opacity:o}=this,h=xe(i,[a,s],[this.source.width,this.source.height],o),u=be(r.colormap,r.colormapOffset),d=this.symbolizerParameters.type==="stretch"?Ie(this.symbolizerParameters):null,l=this.symbolizerParameters.type==="hillshade"?Se(this.symbolizerParameters):null,n=e.emptyTexture;return new Z(h,u,d||l,this._rasterTexture??n,this._transformGridTexture??n,this._colormapTexture??n)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=g(this._rasterTexture),this._transformGridTexture=g(this._transformGridTexture),this._colormapTexture=g(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const i=this.source?this.source.extractBands(r):null;if(!(i?.pixels&&i.pixels.length>0))return void(this._rasterTexture=g(this._rasterTexture));const a=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&a)return;this._rasterTexture=g(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Te(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((a,s)=>a!==r[s])?(this._colormapTexture=g(this._colormapTexture),this._colormapTexture=C(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=C(e,i),void(this._colormap=i)):(this._colormapTexture=g(this._colormapTexture),void(this._colormap=null))}}const Re=t=>{const e=t;let r=class extends e{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return me(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!(i?.type==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?te(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!F(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,a){const{layer:s}=this;if(!i)throw new j("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:o}=s,h=Q(s,a);if(!o||h==null)return[];const u=[],{value:d,magdirValue:l,processedValue:n}=await s.identify(i,{timeExtent:this.timeExtent,signal:a?.signal});let y="";if(d?.length){y=s.type==="imagery-tile"&&s.hasStandardTime()&&d[0]!=null?d.map(R=>s.getStandardTimeValue(R)).join(", "):d.join(", ");const c={ObjectId:0};c[w.servicePixelValue]=s.type==="imagery-tile"&&pe(s.raster)?n?.join(", "):y,c[w.rawServicePixelValue]=y;const O=s.raster?.rasterInfo??s.serviceRasterInfo,A=O?.attributeTable;if(A!=null){const{fields:R,features:H}=A,V=R.find(({name:T})=>T.toLowerCase()==="value"),q=c[w.servicePixelValue],x=V?H.find(T=>String(T.attributes[V.name])===q):null;if(x)for(const T in x.attributes)x.attributes.hasOwnProperty(T)&&(c[de+T]=x.attributes[T])}const E=O?.dataType;E!=="vector-magdir"&&E!=="vector-uv"||(c[w.magnitude]=l?.[0],c[w.direction]=l?.[1]);const{multidimensionalDefinition:k}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});he(s.rasterFields,c,k);const{graphicOrigin:B}=s,N=new Y({geometry:this.fullExtent?.clone(),attributes:c,layer:s,origin:B,sourceLayer:s});u.push(N)}return u}async getSourceScale(){return await this.layer.load(),re(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return F(this.layer.serviceRasterInfo,this.view.spatialReference)}};return m([p()],r.prototype,"fullExtent",null),m([p()],r.prototype,"layer",void 0),m([p({readOnly:!0})],r.prototype,"timeExtent",null),m([p()],r.prototype,"tileInfo",void 0),m([p({readOnly:!0})],r.prototype,"hasTilingEffects",null),m([p()],r.prototype,"datumTransformation",null),r=m([L("esri.views.layers.ImageryTileLayerView")],r),r};let f=class extends Re(fe(se(ie(ce)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new j("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const t=K(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const e=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&e.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:e.toTileInfo(),this.addHandles([S(()=>this.layer.renderer,i=>{this._setSubView(i),this._updatingHandles.addPromise(this.doRefresh())},v),S(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),v)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(t)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this._flowSubView?.destroy()}_setSubView(t){if(this.layer.type==="wcs")return;const e=t?.type==="flow",r=this._flowSubView;e&&r!=null||(r?.destroy(),this._flowSubView=e?new I({layerView:this}):null)}get _blankTile(){const t=document.createElement("canvas"),e=t.getContext("2d"),[r,i]=this.tileInfo.size;return t.width=r,t.height=i,e.clearRect(0,0,r,i),e.getImageData(0,0,r,i)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const t=this.layer.tileInfo,e=this.tileInfo.lodAt(0)?.scale,r=t.lodAt(t.lods.length-1)?.scale;return this.levelRangeFromScaleRange(e,r)}get visibleAtCurrentScale(){return this._flowSubView?.visibleAtCurrentScale??this.tilesVisibleAtCurrentScale()}_getFullExtent(){return F(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}async fetchTile(t,e){const r=this.tileInfo,i=this._canSymbolizeInWebGL(),a={tileInfo:r,requestRawData:i&&!this._hasFlow,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:s}=this,[o,h,u]=t,d=await s.fetchTile(o,h,u,a);if(d instanceof HTMLImageElement)return d;let l=d?.pixelBlock;if(l==null)return this._blankTile;if(!i&&!this._hasFlow&&(l=await s.applyRenderer(d),l==null))return this._blankTile;const n=new ve([o,h,u],l,r.size[0],r.size[1]);return i?(n.symbolizerRenderer=s.symbolizer.rendererJSON,n.symbolizerParameters=s.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(o)),n.transformGrid=d.transformGrid,n.bandIds=s.bandIds):(n.isRendereredSource=!0,n.bandIds=null),n.interpolation=s.interpolation,n}_getSymbolizerOptions(t){const e=this.tileInfo.lodAt(t).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(t){this._canSymbolizeInWebGL()&&JSON.stringify(t.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(t.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t.lij[0])))}createFetchPopupFeaturesQueryGeometry(t,e){return X(t,e,this.view)}async doRefresh(){this.suspended||(this._flowSubView?.doRefresh(),this.emit("data-changed"))}isUpdating(){return this._flowSubView?.updating??!1}_canSymbolizeInWebGL(){const t=ee(),{symbolizer:e}=this.layer,r=e.lookup.colormapLut?.indexedColormap,i=!!this.layer.rasterFunction?.hasClipFunction,a=r&&r.length>4*(t.maxTextureSize||4096);return e.canRenderInWebGL&&!a&&!i}get usedMemory(){return this._flowSubView?.usedMemory??0}get test(){}};m([p({readOnly:!0})],f.prototype,"_blankTile",null),m([p()],f.prototype,"_hasFlow",null),m([p({readOnly:!0})],f.prototype,"imageFormatIsOpaque",null),m([p({readOnly:!0})],f.prototype,"hasMixedImageFormats",null),m([p()],f.prototype,"_flowSubView",void 0),m([p({readOnly:!0})],f.prototype,"dataLevelRange",null),m([p({readOnly:!0})],f.prototype,"visibleAtCurrentScale",null),f=m([L("esri.views.3d.layers.ImageryTileLayerView3D")],f);const Ne=f;export{Ne as default};

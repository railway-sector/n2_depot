import{cK as Ie,aK as Y,cc as q,cI as z,dI as ze,aU as g,q$ as Ne,qX as Ze,yH as He,jJ as Je,kn as ne,S as Qe,sa as J,df as re,l7 as Xe,dY as B,Ds as ee,Dt as oe,dH as Ye,eE as et,jf as le,eb as O,aL as Q,Ah as tt,b0 as st,sh as it,Du as he,xu as de,jO as at,jP as ue,c4 as nt,kp as E,Dv as rt,a9 as Te,an as D,ao as te,e as r,m as h,h as T,bO as ot,cC as pe,BL as lt,ar as H,Dw as ht,bl as dt,aB as K,Dx as ke,wr as ut,Cu as pt,Cy as ct,Cx as gt,CA as mt,Cv as _t,CC as ce,Db as yt,Dy as ge,CD as ft,CG as vt,CH as wt,_ as Vt,CI as Mt,CM as St,CO as Pt,CP as Ct,CQ as Lt,CT as Dt,CU as $t,CV as G,CS as X,oy as me,D0 as bt,CZ as xt,tX as Fe,aF as N,C_ as At,xZ as Ot,aG as _e,aH as ye,v2 as Rt,ja as Gt,jb as fe,e_ as It,w2 as Z,eX as se,eY as ve,ie as zt,wz as Ht,k as Tt,ap as V,Dz as kt,fb as we,mK as Ft,wA as Et,jR as Ve,eg as Ut,mC as Wt,DA as jt,ac as Me,i as qt,iN as Bt,ew as U,ex as Se,cQ as Kt,nO as Pe,rL as Nt,cE as Zt}from"./index-FjkLmFqq.js";import{e as Jt}from"./getDefaultUnitForView-DdtglU2G.js";import{e as Qt}from"./AnalysisView3D-BR0sy4E4.js";import{m as Xt,d as Yt,j as es,p as ts,h as ss,w as Ce}from"./measurementUtils-6DIeeXjz.js";import{k as Le,o as is}from"./geodesicAreaMeasurementUtils-BixCeMie.js";import{r as as,W as ns,ah as rs,a2 as os,g as ls}from"./euclideanLengthMeasurementUtils-A0_x-TQ2.js";import{a as hs,o as ds,p as I,g as De,t as $e,Y as be}from"./ShadedColorMaterial.glsl-CYREHtk3.js";import{g as ie,w as Ee,a as Ue}from"./EditGeometryOperations-ryVKgTg3.js";import{d as We}from"./quantityFormatUtils-DK-ADnr4.js";import{f as xe,_ as us,m as ps}from"./Segment-EAsASO-c.js";import{f as je}from"./DefaultLayouts-D_5QC3IU.js";import{i as cs}from"./TriangleMaterial-D8j278z7.js";import{h as gs}from"./lineStippleUtils-CCavR4OV.js";import{w as ms}from"./SnappingVisualizer3D-Lr2R49I6.js";import{O as _s,G as ys}from"./dragEventPipeline3D-CkYA9_7h.js";import{c as fs}from"./LaserlinePath.glsl-BHqZqJkV.js";import{a as qe,p as vs}from"./InteractiveToolBase-CxOXQFBA.js";import{o as ws}from"./ToolIntersector-D5ZuMWOg.js";import{o as Vs,m as Ms,f as Ss,d as Ps}from"./analysisViewUtils-YhhrYG6k.js";import{e as Cs}from"./SnappingContext-YSCROIAK.js";import{f as Ls}from"./SnappingDragPipelineStep-8G0avuXz.js";import{a as Ds}from"./SnappingManagerPool--KtVYTUf.js";import{p as $s}from"./SnappingOperation-sxNwP-1s.js";import"./earcut-D9gy186-.js";import"./utils-DecFH9K9.js";import"./geometry2dUtils-DpG_6IxJ.js";import"./geodeticLengthOperator-DkJJgyg3.js";import"./geodeticCurveType-CirnHLSB.js";import"./VisualElement-CwXz23ML.js";import"./line-H42fXCXZ.js";import"./ColorMaterial.glsl-UHDFE1MX.js";import"./rotate-Du9z8cCf.js";import"./curveOperationUtils-DwG-6fMd.js";import"./TextOverlayItem-BCn2o_Le.js";import"./ExtendedLineVisualElement-Tjk-4qEE.js";import"./EngineVisualElement-CLZJBrw1.js";import"./PointVisualElement-BsPc6Ly2.js";import"./PointSnappingHint-9yDqW7xC.js";import"./dehydratedFeatureComparison-CzcDkiS6.js";import"./allLayerSnapping-CN2h1BQW.js";function Ae(s,e,t,i,a){Ie(W,s),Y(j,s,e),q(W,t,W,a),q(j,t,j,a),z(i,j,W),ze(i,i)}const W=g(),j=g();class bs{get numVertices(){return this._length}get hasStagedVertex(){return this._lastCursorPoint!=null}constructor(e,t,i){this._sceneView=e,this._geodesicAreaMeasurementUtils=t,this._geodesicLengthMeasurementUtils=i,this.validMeasurement=!1,this.positionsWorld=[],this.positionsRender=[],this.positionsFittedWorld=[],this.positionsFittedRender=[],this.positionsGeodesic=[],this.positionsSpherical=[],this.positionsStereographic=[],this.pathSegmentLengths=[],this.geodesicPathSegmentLengths=[],this.perimeterSegmentLengths=[],this.intersectingSegments=new Set,this.geodesicIntersectingSegments=new Set,this.triangleIndices=null,this.geodesicTriangleIndices=null,this.areaCentroidWorldCoords=g(),this.areaCentroidRenderCoords=g(),this.geodesicAreaCentroidRenderCoords=g(),this.fittingMode=null,this.area=null,this.geodesicArea=null,this.pathLength=null,this.geodesicPathLength=null,this.perimeterLength=null,this._length=0,this._centroidRenderCoords=g(),this._planeWorldCoords=Ne(),this._worldUp=g(),this._worldTangent=g(),this._frame=[g(),g(),g()],this._lastPathVersion=-1,this._lastCursorPoint=null,this._mode=null,this._tempU=g(),this._tempV=g(),this._tempVec3=g(),this._tempSphere=Ze();const a=as(e.spatialReference);this._measurementSR=a,this._lengthMeasurementUnit=He(a)??"meters",this._areaMeasurementUnit=Je(a)??"square-meters"}update(e,t,i,a,n,o){const l=this._lastPathVersion===e.version,d=t?t.equals(this._lastCursorPoint):this._lastCursorPoint==null,u=this._mode===n;return!(l&&!o&&u&&d)&&(this._lastPathVersion=e.version,this._lastCursorPoint=t,this._updateCursorSegmentLength(e,t),this._update(e,t,i,a,n),!0)}_update(e,t,i,a,n){const o=this._sceneView.renderSpatialReference,l=this._measurementSR,d=i.spatialReference;let u=e.numVertices;const p=!(t==null||t.equals(e.lastPoint)||u>2&&t.equals(e.firstPoint)||e.polygonIsClosed);p&&(u+=1);const c=!e.polygonIsClosed&&u>2,f=e.polygonIsClosed||c;this._resize(u);const _=ne(d),m=d!=null&&ns(d)?d:null,v=m!=null&&Qe(d,_),{positionsGeodesic:S,positionsWorld:k,positionsRender:F,positionsSpherical:C}=this,x=(P,$)=>{xs(i.elevationProvider,P),E(P,k[$],l),E(P,F[$],o),v&&(E(P,S[$],m),E(P,C[$],_),ze(C[$],C[$]))};e.forEachVertexPosition((P,$)=>x(P,$)),p&&x(t,u-1);const A=this._updatePathLengths(f);if(this.pathLength=this._length>1?J(A,this._lengthMeasurementUnit):null,v){const P=this._updateGeodesicPathLengths(f,m);this.geodesicPathLength=P!=null&&this._length>1?P:null}else this.geodesicPathLength=null;if(this._updateMode(n),!f)return this.area=null,this.geodesicArea=null,this.perimeterLength=null,this.triangleIndices=null,this.geodesicTriangleIndices=null,this.intersectingSegments.clear(),this.geodesicIntersectingSegments.clear(),void(this.validMeasurement=!1);this._updateAreaAndPerimeterLength(i,o,l,a),v&&this._updateGeodesicArea(i,m),this.validMeasurement=!0}getData(){return{validMeasurement:this.validMeasurement,numVertices:this.numVertices,hasStagedVertex:this.hasStagedVertex,positionsRender:this.positionsRender,positionsFittedWorld:this.positionsFittedWorld,positionsFittedRender:this.positionsFittedRender,intersectingSegments:this.intersectingSegments,geodesicIntersectingSegments:this.geodesicIntersectingSegments,triangleIndices:this.triangleIndices,geodesicTriangleIndices:this.geodesicTriangleIndices,areaCentroidRenderCoords:this.areaCentroidRenderCoords,geodesicAreaCentroidRenderCoords:this.geodesicAreaCentroidRenderCoords,area:this.area,geodesicArea:this.geodesicArea,pathLength:this.pathLength,geodesicPathLength:this.geodesicPathLength,perimeterLength:this.perimeterLength,actualMeasurementMode:this.actualMeasurementMode}}_resize(e){for(e<this._length&&(this.positionsWorld.length=e,this.positionsRender.length=e,this.positionsFittedWorld.length=e,this.positionsFittedRender.length=e,this.positionsGeodesic.length=e,this.positionsSpherical.length=e,this.positionsStereographic.length=e,this.pathSegmentLengths.length=e,this.geodesicPathSegmentLengths.length=e,this.perimeterSegmentLengths.length=e,this._length=e);this._length<e;)this.positionsWorld.push(g()),this.positionsRender.push(g()),this.positionsFittedWorld.push(re()),this.positionsFittedRender.push(g()),this.positionsGeodesic.push(g()),this.positionsSpherical.push(g()),this.positionsStereographic.push(re()),this.pathSegmentLengths.push(0),this.geodesicPathSegmentLengths.push(0),this.perimeterSegmentLengths.push(0),++this._length}_updatePathLengths(e){const t=this.positionsWorld,i=this.pathSegmentLengths;let a=0;const n=this._length;for(let o=0;o<n;++o){const l=i[o]=Xe(t[o],t[(o+1)%n]);(o<n-1||e)&&(a+=l)}return a}_updateGeodesicPathLengths(e,t){const i=this.positionsGeodesic,a=this.geodesicPathSegmentLengths;let n=0;const o=this._length;for(let l=0;l<o;++l){const d=this._geodesicLengthMeasurementUtils.geodesicDistance(i[l],i[(l+1)%o],t);if(d==null)return null;const u=B(d,"meters").value,p=a[l]=u;(l<o-1||e)&&(n+=p)}return J(n,"meters")}_updateAreaAndPerimeterLength(e,t,i,a){const n=e.renderCoordsHelper,o=this.positionsWorld,l=this.positionsRender,d=this.positionsFittedWorld,u=this.positionsFittedRender,p=this._planeWorldCoords,c=this._centroidRenderCoords;ee(l,c),n.worldUpAtPosition(c,this._worldUp),n.worldBasisAtPosition(c,0,this._worldTangent),Ae(c,this._worldUp,t,this._worldUp,i),Ae(c,this._worldTangent,t,this._worldTangent,i),o.length>2&&Xt(o,p),this.fittingMode=this._selectFittingMode(p,o,this._worldUp,a);let f=0;if(this.fittingMode==="horizontal"){let C=-1/0;l.forEach((x,A)=>{const P=n.getAltitude(l[A]);P>C&&(C=P,f=A)})}const _=o[f];let m=p,v=this._worldTangent;this.fittingMode==="horizontal"?m=this._worldUp:this.fittingMode==="vertical"&&(m=this._tempVec3,v=this._worldUp,oe(p,this._worldUp,m)),Ie(this._frame[2],m),oe(v,m,this._frame[0]),Ye(this._frame[1],this._frame[0],this._frame[2]),et(this._frame[1],this._frame[1]);const S=this._tempVec3,k=this._tempU,F=this._tempV;for(let C=0;C<this._length;++C){const x=d[C],A=u[C];z(S,o[C],_),le(x,O(this._frame[0],S),O(this._frame[1],S)),Q(k,this._frame[0],x[0]),Q(F,this._frame[1],x[1]),Y(S,k,F),Y(S,S,_),q(S,i,A,t)}this.perimeterLength=this._length>0?this._updatePerimeterLengths():null,ee(u,this.areaCentroidRenderCoords),q(this.areaCentroidRenderCoords,t,this.areaCentroidWorldCoords,i),this._updateIntersectingSegments(),this.area=this.intersectingSegments.size===0?this._computeArea():null}_updateGeodesicArea(e,t){const{renderCoordsHelper:i,spatialReference:a}=e,{positionsSpherical:n,positionsStereographic:o}=this,l=this._tempVec3,d=Yt(n,l);if(!d)return void(this.geodesicArea=null);const u=this._tempU,p=this._tempV;tt(l,u,p);for(let c=0;c<this._length;++c){const f=O(n[c],u),_=O(n[c],p),m=O(n[c],l);le(o[c],f/m,_/m)}Q(l,l,st(a).radius),i.toRenderCoords(l,ne(a),this.geodesicAreaCentroidRenderCoords),this._updateGeodesicIntersectingSegments(),this.geodesicArea=d&&this.geodesicIntersectingSegments.size===0?this._computeGeodesicArea(t):null}_updatePerimeterLengths(){const e=this.positionsFittedWorld,t=this.perimeterSegmentLengths;let i=0;for(let a=0;a<this._length;++a)i+=t[a]=it(e[a],e[(a+1)%this._length]);return J(i,this._lengthMeasurementUnit)}_updateIntersectingSegments(){const e=this.positionsFittedWorld,t=this.intersectingSegments;t.clear();for(let i=0;i<this._length;++i)for(let a=i+2;a<this._length;++a){if((a+1)%this._length===i)continue;const n=e[i],o=e[(i+1)%this._length],l=e[a],d=e[(a+1)%this._length];he(n,o,l,d)&&(t.add(i),t.add(a))}}_computeArea(){const e=this.positionsFittedWorld,t=this.triangleIndices=de(Le(e));let i=0;for(let a=0;a<t.length;a+=3)i+=at(e[t[a]],e[t[a+1]],e[t[a+2]]);return ue(i,this._areaMeasurementUnit)}_updateGeodesicIntersectingSegments(){const e=this.positionsStereographic,t=this.geodesicIntersectingSegments;t.clear();for(let i=0;i<this._length;++i)for(let a=i+2;a<this._length;++a){if((a+1)%this._length===i)continue;const n=e[i],o=e[(i+1)%this._length],l=e[a],d=e[(a+1)%this._length];he(n,o,l,d)&&(t.add(i),t.add(a))}}_computeGeodesicArea(e){const t=this.positionsGeodesic,i=this.positionsStereographic,a=this.geodesicTriangleIndices=de(Le(i));let n=0;for(let o=0;o<a.length;o+=3){const l=es(t[a[o]],t[a[o+1]],t[a[o+2]],e,this._geodesicAreaMeasurementUtils);if(l==null)return null;n+=B(l,"square-meters").value}return ue(n,"square-meters")}_selectFittingMode(e,t,i,a){const n=t.map(p=>Math.abs(ts(e,p))).reduce((p,c)=>Math.max(p,c),0);ss(t,this._tempSphere);const o=n/(2*this._tempSphere[3]),l=o<a.maxRelativeErrorCoplanar,d=o<a.maxRelativeErrorAlmostCoplanar;let u="horizontal";return l?u="oblique":d&&(u=Math.abs(O(i,e))>Math.cos(nt(a.verticalAngleThreshold))?"horizontal":"vertical"),u}_updateCursorSegmentLength(e,t){const i=e.lastPoint;e.isValidPolygon||i==null||t==null?(this.geodesicStagedSegmentLength=null,this.stagedSegmentLength=null):(this.geodesicStagedSegmentLength=this._geodesicLengthMeasurementUtils.geodesicDistanceBetweenPoints(i,t),this.stagedSegmentLength=rs(i,t)?.direct)}_updateMode(e){if(e===0){this.actualMeasurementMode="euclidean";let t=0;this.geodesicPathLength!=null&&(t+=this.geodesicPathLength.value),t>As&&(this.actualMeasurementMode="geodesic")}else this.actualMeasurementMode=e===1?"euclidean":"geodesic";this.geodesicPathLength==null&&(this.actualMeasurementMode="euclidean"),this._mode=e}}function xs(s,e){e.hasZ||(e.z=rt(s,e,"ground")??0)}const As=1e5;let b=class extends Te{constructor(e){super(e)}initialize(){this._measurementDataManager=new bs(this.view,this.geodesicAreaMeasurementUtils,this.geodesicLengthMeasurementUtils),this.addHandles([this.analysisViewData.path.on("change",()=>this._update()),D(()=>this.analysisViewData.stagedPoint,()=>this._update(),te),D(()=>this.analysisViewData.mode,()=>this._update(),te)]),this._update()}_update(e=!1){const{analysisViewData:t,view:i}=this,a={maxRelativeErrorCoplanar:.005,maxRelativeErrorAlmostCoplanar:.01,verticalAngleThreshold:80};this._measurementDataManager.update(t.path,t.stagedPoint,i,a,t.mode,e)&&(t.measurementData=this._measurementDataManager.getData())}};r([h({constructOnly:!0})],b.prototype,"view",void 0),r([h({constructOnly:!0})],b.prototype,"analysis",void 0),r([h({constructOnly:!0})],b.prototype,"analysisViewData",void 0),r([h({constructOnly:!0})],b.prototype,"geodesicAreaMeasurementUtils",void 0),r([h({constructOnly:!0})],b.prototype,"geodesicLengthMeasurementUtils",void 0),b=r([T("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementController")],b);let L=class extends ot{constructor(e={}){super(e),this._version=0,this._internalGeometryChange=!1,this._extent=pe()}set areaMeasurement(e){this._set("areaMeasurement",e),e!=null&&this.view!=null&&this._initialize(e,this.view)}set view(e){this._set("view",e),e!=null&&this.areaMeasurement!=null&&this._initialize(this.areaMeasurement,e)}get constructed(){return this.areaMeasurement!=null&&this.view!=null}get version(){return this._version}get isEmptyPolygon(){return!this.constructed||this._editGeometry.parts.length===0}get isValidPolygon(){return this.constructed&&this.polygonIsClosed}get extent(){if(this.constructed&&this._editGeometry.parts[0]?.vertices.length){const e=pe(this._extent);return this.forEachVertex(t=>{lt(e,t.pos)}),e}return null}get spatialReference(){return this.constructed?this._editGeometry.coordinateHelper.spatialReference:null}_initialize(e,t){this.removeAllHandles(),this.addHandles(D(()=>e.geometry,()=>{this._updateEditGeometryFromModelGeometry(e,t)},H)),this._makeDirty(!0)}_makeDirty(e=!1){this.notifyChange("polygonIsClosed"),this.notifyChange("isValidPolygon"),this.notifyChange("initialized"),this.notifyChange("extent"),e&&this.notifyChange("numVertices")}_updateEditGeometryFromModelGeometry(e,t){if(this._version++,this._internalGeometryChange)return;this.removeHandles("EditGeometry");let i=e.geometry;if(i!=null){const a=ht(i,t.spatialReference);a==null&&hs(e,i.spatialReference,dt.getLogger(this)),i=a}this._editGeometryOperations=i!=null?ie.fromGeometry(i,t.state.viewingMode):new ie(new Ee("polygon",Ue(!0,!1,t.spatialReference)),t.state.viewingMode),this._makeDirty(!0),this.emit("change"),this.addHandles(this._editGeometry.on("change",a=>{this._makeDirty(a.addedVertices!=null||a.removedVertices!=null),this._internalGeometryChange=!0,e.geometry=this.numVertices>0?this._editGeometry.geometry:null,this._internalGeometryChange=!1}),"EditGeometry")}get _editGeometry(){return this._editGeometryOperations.data}get vertices(){const e=[];return this.forEachVertex(t=>{e.push(t)}),e}get numVertices(){return this.constructed?this._editGeometry.parts[0]?.vertices.length??0:0}get polygonIsClosed(){return this._editGeometry.parts[0]?.isClosed()??!1}get firstPoint(){if(this.constructed){const{coordinateHelper:e,parts:t}=this._editGeometry,i=t[0]?.getFirstVertex();if(i!=null)return e.vectorToPoint(i.pos)}return null}get lastPoint(){if(this.constructed){const{coordinateHelper:e,parts:t}=this._editGeometry,i=t[0]?.getLastVertex();if(i!=null)return e.vectorToPoint(i.pos)}return null}getVertex(e){if(!this.constructed||!this._editGeometry.parts[0]?.vertices.length)return null;const t=this._editGeometry.parts[0].vertices[0];let i=t;do{if(i.index===e)return i;i=i.rightSegment.rightVertex}while(i!==t&&i!=null);return null}getVertexPositionAsPoint(e){return this._editGeometry.coordinateHelper.vectorToPoint(e.pos)}getVertexPositionAsPointFromIndex(e){return this._editGeometry.coordinateHelper.vectorToPoint(this.getVertex(e).pos)}forEachVertex(e){if(this.constructed&&this._editGeometry.parts.length>0)for(const t of this._editGeometry.parts[0].iterateVertices())e(t,t.index)}forEachVertexPosition(e){const t=this._editGeometry.coordinateHelper;this.forEachVertex((i,a)=>{t.vectorToPoint(i.pos,Oe),e(Oe,a)})}clear(){this.areaMeasurement!=null&&(this.areaMeasurement.geometry=null)}add(e){if(!this.constructed)return null;const t=this._editGeometryOperations.appendVertex(this._editGeometry.coordinateHelper.pointToVector(e),this._editGeometry.parts.at(0));return this.emit("change"),t}close(){if(!this.constructed||this._editGeometry.parts.length===0)return null;const e=this._editGeometryOperations.closePart(this._editGeometry.parts[0]);return this.emit("change"),e}ensureContains(e,t=""){let i=!1;if(this._editGeometry.parts.forEach(a=>{for(const n of a.iterateVertices())n===e&&(i=!0)}),!i)throw new Error(`vertex doesn't exist ${t}`);return i}setVertexPosition(e,t){if(!this.constructed)return null;const i=this._editGeometryOperations.setVertexPosition(e,this._editGeometry.coordinateHelper.pointToVector(t));return this.emit("change"),i}equals(e){if(this.numVertices!==e.numVertices)return!1;let t=!0;return this.forEachVertexPosition((i,a)=>{const n=e.getVertexPositionAsPointFromIndex(a);i.equals(n)||(t=!1)}),!!t}};r([h({value:null})],L.prototype,"areaMeasurement",null),r([h({value:null})],L.prototype,"view",null),r([h()],L.prototype,"isEmptyPolygon",null),r([h()],L.prototype,"isValidPolygon",null),r([h()],L.prototype,"extent",null),r([h()],L.prototype,"spatialReference",null),r([h()],L.prototype,"numVertices",null),r([h()],L.prototype,"polygonIsClosed",null),L=r([T("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementPathHelper")],L);const Oe=new K;function ae(s,e){return B(s,ke(s.value,s.unit,e))}function Re(s,e){return B(s,Be(s,e))}function Be(s,e){const t=Os(e);return ut(s.value,s.unit,t)}function Os(s){switch(s){case"metric":case"ares":case"hectares":return"metric";case"imperial":case"acres":return"imperial";case"square-inches":return"inches";case"square-feet":return"feet";case"square-yards":return"yards";case"square-miles":return"miles";case"square-nautical-miles":return"nautical-miles";case"square-us-feet":return"us-feet";case"square-millimeters":return"millimeters";case"square-centimeters":return"centimeters";case"square-decimeters":return"decimeters";case"square-meters":return"meters";case"square-kilometers":return"kilometers"}throw new Error("unhandled area unit")}function Ke(s){const e=new pt,{vertex:t,fragment:i,varyings:a}=e;return e.fragment.include(ct,s),e.include(gt,s),e.include(mt,s),_t(t,s),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),a.add("vUV","vec2"),a.add("vpos","vec3"),t.main.add(ce`vUV = uv0;
vpos = position;
forwardViewPosDepth((view * vec4(position, 1.0)).xyz);
gl_Position = proj * view * vec4(position, 1.0);`),i.uniforms.add(new yt("size",n=>n.size)),i.uniforms.add(new ge("color1",n=>n.color1)),i.uniforms.add(new ge("color2",n=>n.color2)),i.include(ft),i.main.add(ce`discardByTerrainDepth();
vec2 uvScaled = vUV / (2.0 * size);
vec2 uv = fract(uvScaled - 0.25);
vec2 ab = clamp((abs(uv - 0.5) - 0.25) / fwidth(uvScaled), -0.5, 0.5);
float fade = smoothstep(0.25, 0.5, max(fwidth(uvScaled.x), fwidth(uvScaled.y)));
float t = mix(abs(ab.x + ab.y), 0.5, fade);
fragColor = mix(color2, color1, t);
outputColorHighlightOID(fragColor, vpos, fragColor.rgb);`),e}const Rs=Object.freeze(Object.defineProperty({__proto__:null,build:Ke},Symbol.toStringTag,{value:"Module"}));class Gs extends vt{constructor(e,t){super(e,t,new wt(Rs,()=>Vt(()=>Promise.resolve().then(()=>Xs),void 0)),je.locations)}initializePipeline(e){const{oitPass:t,transparent:i,polygonOffset:a,output:n}=e,o=t===0,l=t===2;return Mt({blending:i?Dt(t):null,depthTest:{func:Lt(t)},depthWrite:Ct(e),drawBuffers:Pt(t,n),colorWrite:St,polygonOffset:o||l?a?Is:null:{factor:-1,units:-25}})}}const Is={factor:0,units:-25};class R extends $t{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.polygonOffset=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.output=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.draped=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}}r([G()],R.prototype,"transparent",void 0),r([G()],R.prototype,"writeDepth",void 0),r([G()],R.prototype,"polygonOffset",void 0),r([G()],R.prototype,"terrainDepthTest",void 0),r([G()],R.prototype,"cullAboveTerrain",void 0);class zs extends cs{constructor(e){super(e,Ts),this._configuration=new R,this.produces=new Map([[2,t=>X(t)&&!this.transparent],[4,t=>X(t)&&this.transparent&&this.parameters.writeDepth],[8,t=>X(t)&&this.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.transparent=this.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color1[3]>=me||this.parameters.color2[3]>=me}get transparent(){return this.parameters.color1[3]<1||this.parameters.color2[3]<1}createGLMaterial(e){return new Hs(e)}createBufferWriter(){return new bt(je)}}class Hs extends At{beginSlot(e){return this.getTechnique(Gs,e)}}class Ts extends xt{constructor(){super(...arguments),this.size=Fe(1,1),this.color1=N(.75,.75,.75,1),this.color2=N(.5,.5,.5,1),this.writeDepth=!0,this.polygonOffset=!1}}class ks extends ds{constructor(e){super(e),this._checkerBoardMaterial=null,this._renderOccluded=4,this._geometry=null,this._size=Fe(1,1),this._color1=N(1,.5,0,.5),this._color2=N(1,1,1,.5),this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){Ot(this._size,e),this._updateMaterial()}get color1(){return this._color1}set color1(e){_e(e,this._color1)||(ye(this._color1,e),this._updateMaterial())}get color2(){return this._color2}set color2(e){_e(e,this._color2)||(ye(this._color2,e),this._updateMaterial())}_updateMaterial(){this._checkerBoardMaterial?.setParameters({size:this._size,color1:this._color1,color2:this._color2,renderOccluded:this._renderOccluded})}createExternalResources(){this._checkerBoardMaterial=new zs({size:this._size,color1:this._color1,color2:this._color2,writeDepth:!1,polygonOffset:!0,renderOccluded:4,isDecoration:this.isDecoration})}destroyExternalResources(){this._checkerBoardMaterial=null}forEachMaterial(e){e(this._checkerBoardMaterial)}createGeometries(e){if(this._geometry==null||this._checkerBoardMaterial==null)return;const t=Fs;Rt(t,this.transform);const i=this._geometry,a=[],n=g();i.position.forEach(d=>{z(n,d,t),a.push(n[0],n[1],n[2])});const o=[];i.uv.forEach(d=>{o.push(d[0],d[1])});const l=new Gt(this._checkerBoardMaterial,[["position",new fe(a,i.triangleIndices,3,!0)],["uv0",new fe(o,i.triangleIndices,2,!0)]]);e.addGeometry(l)}}const Fs=g();let M=class extends Te{get _parameters(){const{accentColor:s,textColor:e}=this.view.effectiveTheme,t=It(s),i=Z(s,.5),a=Z(se(s),.5),n=se(e,160);return{accentColor:t,transparentAccentColor:i,transparentContrastColor:a,intersectingLineColor:[1,.2,0,1],textColor:e,textBackgroundColor:ve(n,.6),textCalloutColor:ve(n,.5),pathLineWidth:3,perimeterLineWidth:2,projectionLineWidth:2,projectionLineStippleSize:5,labelDistance:25}}get visible(){return this.analysisViewData.visible}get _renderUnits(){const s=this.view.renderCoordsHelper.spatialReference;return He(s)??"meters"}get testData(){}constructor(s){super(s),this._path=null,this._intersectedPath=null,this._perimeter=null,this._intersectedPerimeter=null,this._projectionLines=null,this._measurementArea=null,this._areaLabel=null,this._perimeterLengthLabel=null,this._pathSegments=[],this._perimeterSegments=[],this._origin=g(),this._originTransform=zt(),this.messages=null,this.viewData=Ws,this.areaLabel=null,this.perimeterLengthLabel=null,this.loadingMessages=!0}initialize(){const{analysisViewData:s,_parameters:e,view:t}=this;this._path=new I({view:t,attached:!0,width:e.pathLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._intersectedPath=new I({view:t,attached:!0,width:e.pathLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._perimeter=new I({view:t,attached:!0,width:e.perimeterLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._intersectedPerimeter=new I({view:t,attached:!0,width:e.perimeterLineWidth,color:e.intersectingLineColor,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._projectionLines=new I({view:t,attached:!0,width:e.projectionLineWidth,stipplePattern:gs(e.projectionLineStippleSize),polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._measurementArea=new ks({view:t,attached:!0,isDecoration:!0});const i={attached:!0,view:t,isDecoration:!0};this._areaLabel=new xe({...i,fontSize:16}),this._perimeterLengthLabel=new xe({...i,fontSize:12}),this.addHandles([D(()=>[s.mode,this.visible,s.unit,s.measurementData,s.stagedPoint],()=>this._update(),H),D(()=>t.state?.camera,()=>this._updateLabels(),H),Ht(()=>this._updateMessageBundle()),D(()=>this._parameters,({accentColor:a,transparentAccentColor:n,transparentContrastColor:o,textColor:l,textBackgroundColor:d,textCalloutColor:u})=>{const{_path:p,_intersectedPath:c,_perimeter:f,_projectionLines:_,_measurementArea:m,_areaLabel:v,_perimeterLengthLabel:S}=this;p.color=a,c.color=a,f.color=a,_.color=a,m.color1=n,m.color2=o,v.textColor=l,v.backgroundColor=d,v.calloutColor=u,S.textColor=l,S.backgroundColor=d,S.calloutColor=u},Tt)]),this._updateMessageBundle()}destroy(){this._measurementArea=V(this._measurementArea),this._path=V(this._path),this._intersectedPath=V(this._intersectedPath),this._perimeter=V(this._perimeter),this._intersectedPerimeter=V(this._intersectedPerimeter),this._areaLabel=V(this._areaLabel),this._perimeterLengthLabel=V(this._perimeterLengthLabel),this._projectionLines=V(this._projectionLines),this.set("view",null)}_update(){if(this.destroyed||!this.view.ready||!this.view.renderCoordsHelper)return;const{analysisViewData:{measurementData:s},analysisViewData:e}=this;s!=null&&(this._updateViewData(s,e.path),this._updateOrigin(),this._updatePathSegments(),this._updatePerimeterSegments(),this._updateArea(),this._updateProjectionLines(),this._updateLabels())}_updateViewData(s,e){const t=s.validMeasurement,i=s.actualMeasurementMode==="geodesic",a=i?s.geodesicArea:s.area;let n=1;if(a){const l=ae(a,this.analysisViewData.unit);n=kt(Math.sqrt(l.value)/Math.sqrt(300)),n*=Math.sqrt(we(1,l.unit,"square-meters")),n=we(n,"meters",this._renderUnits)}const o={validMeasurement:t,numVertices:s.numVertices,hasStagedVertex:s.hasStagedVertex,path:e,mode:s.actualMeasurementMode,positionsRender:s.positionsRender,positionsFittedWorld:s.positionsFittedWorld,positionsFittedRender:s.positionsFittedRender,intersectingSegments:i?s.geodesicIntersectingSegments:s.intersectingSegments,triangleIndices:i?s.geodesicTriangleIndices:s.triangleIndices,areaCentroid:i?s.geodesicAreaCentroidRenderCoords:s.areaCentroidRenderCoords,perimeterLengthLabelSegmentIndex:0,area:i?s.geodesicArea:s.area,pathLength:i?s.geodesicPathLength:s.pathLength,perimeterLength:s.perimeterLength,checkerSize:n};this._set("viewData",o)}_updateOrigin(){const s=this.viewData;ee(s.positionsRender,this._origin),Ft(this._originTransform,this._origin),this._measurementArea.transform=this._originTransform,this._projectionLines.transform=this._originTransform}_createSegments(s){const e=this.viewData,t=this.view.renderCoordsHelper.spatialReference,i=e.mode,a=[],n=[],o=[],l=e.numVertices,d=e.validMeasurement?l:l-1;for(let p=0;p<d;++p){const c=e[s][p],f=e[s][(p+1)%l];let _=null;switch(i){case"euclidean":_=new ps(c,f);break;case"geodesic":_=new us(c,f,t)}e.intersectingSegments.has(p)?o.push(_):n.push(_),a.push(_)}let u=null;return e.validMeasurement&&e.hasStagedVertex&&d>=2?u=a[a.length-2]:e.hasStagedVertex&&d>=1&&(u=a[a.length-1]),{all:a,nonIntersecting:n,intersecting:o,stagedSegment:u}}_updatePathSegments(){const{visible:s}=this,e=this._createSegments("positionsRender");this._path.setGeometryFromSegments(e.nonIntersecting,this._origin),this._path.visible=s,this._intersectedPath.setGeometryFromSegments(e.intersecting,this._origin),this._intersectedPath.visible=s,this._pathSegments=e.all}_updatePerimeterSegments(){const s=this.visible&&this.viewData.mode==="euclidean"&&this.viewData.path.numVertices>2,e=this._createSegments("positionsFittedRender");this._perimeter.setGeometryFromSegments(e.nonIntersecting,this._origin),this._perimeter.visible=s,this._intersectedPerimeter.setGeometryFromSegments(e.intersecting,this._origin),this._intersectedPerimeter.visible=s,this._perimeterSegments=e.all}_updateArea(){const s=this.viewData;switch(s.mode){case"euclidean":this._updateAreaEuclidean(s);break;case"geodesic":this._updateAreaGeodesic()}}_updateAreaEuclidean(s){const e=this.visible;s.validMeasurement&&s.intersectingSegments.size===0&&s.triangleIndices?(this._measurementArea.geometry={uv:s.positionsFittedWorld,position:s.positionsFittedRender,triangleIndices:s.triangleIndices},this._measurementArea.size=[s.checkerSize,s.checkerSize],this._measurementArea.visible=e):this._measurementArea.visible=!1}_updateAreaGeodesic(){this._measurementArea.visible=!1}_updateProjectionLines(){const s=this.viewData,e=this.visible,t=s.mode,i=s.numVertices;if(i>0&&s.validMeasurement&&t==="euclidean"){const a=[];for(let n=0;n<i;++n){const o=g();z(o,s.positionsRender[n],this._origin);const l=g();z(l,s.positionsFittedRender[n],this._origin),a.push([o,l])}this._projectionLines.geometry=a,this._projectionLines.visible=e}else this._projectionLines.geometry=null,this._projectionLines.visible=!1}_updateLabels(){if(this.destroyed)return;const{viewData:s}=this,{area:e,path:t}=s;if(!t)return;const i=this.visible,a=this._areaLabel,n=this._perimeterLengthLabel,o=s.validMeasurement;a.visible=!0,n.visible=!0;let l=!1;const d=Es(this.messages,e,this.analysisViewData.unit);if(d!=null&&i&&(a.geometry={type:"point",point:s.areaCentroid},a.text=d,l=s.validMeasurement&&s.intersectingSegments.size===0),this._set("areaLabel",d),i&&o&&s.intersectingSegments.size===0){const u=s.mode==="geodesic",p=u?s.pathLength:s.perimeterLength,c=Us(this.messages,p,this.analysisViewData.unit);this._set("perimeterLengthLabel",c),n.distance=this._parameters.labelDistance,n.anchor="top",n.text=c;let f=!0;for(let _=0;_<s.numVertices;++_){const m=(s.perimeterLengthLabelSegmentIndex+_)%s.numVertices,v=u?this._pathSegments[m]:this._perimeterSegments[m];if(f=!0,n.geometry={type:"segment",segment:v,sampleLocation:"center"},!n.overlaps(this._areaLabel))break;f=!1}n.visible=f}else n.visible=!1;a.visible=l}_updateMessageBundle(){this.loadingMessages=!0,Et("esri/core/t9n/Units").then(s=>{this.messages=s,this.view&&this._update()}).finally(()=>{this.loadingMessages=!1})}};function Es(s,e,t){return s&&e&&We(s,e,ke(e.value,e.unit,t))}function Us(s,e,t){return s&&e&&We(s,e,Be(e,t))}r([h()],M.prototype,"_parameters",null),r([h()],M.prototype,"view",void 0),r([h()],M.prototype,"messages",void 0),r([h()],M.prototype,"analysis",void 0),r([h()],M.prototype,"viewData",void 0),r([h()],M.prototype,"analysisViewData",void 0),r([h({readOnly:!0})],M.prototype,"areaLabel",void 0),r([h({readOnly:!0})],M.prototype,"perimeterLengthLabel",void 0),r([h()],M.prototype,"loadingMessages",void 0),r([h()],M.prototype,"visible",null),r([h()],M.prototype,"_renderUnits",null),M=r([T("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementVisualization")],M);const Ws={validMeasurement:!1,numVertices:0,hasStagedVertex:!1,path:null,mode:null,positionsRender:null,positionsFittedWorld:null,positionsFittedRender:null,intersectingSegments:null,triangleIndices:null,areaCentroid:null,perimeterLengthLabelSegmentIndex:null,checkerSize:null,area:null,pathLength:null,perimeterLength:null};class js{constructor(e,t=null){this.screenPoint=e,this.result=t}}class qs{constructor(e,t){this.scenePoint=e,this.mapPoint=t}}class Bs{constructor(e){this.vertexManipulators=[],this._destroyed=!1,this._isManipulatorsOwner=!0,this._visible=!0,this._listenerHandles=null,this._tempHandlePosition=g();const{analysisViewData:t,manipulators:i,toolState:a,view:n,visible:o}=e;this._analysisViewData=t,this._toolState=a,i!=null?(this._manipulators=i,this._isManipulatorsOwner=!1):this._manipulators=new qe,this._view=n,this._intersector=ws(n.state.viewingMode);const l=De(this._handleColor),d=[new $e(Ve(l,1,32,32))],u=new be({view:n,renderObjects:d});u.available=!1,u.radius=Ge,u.interactive=!1,this._manipulators.add(u),this._cursorManipulator=u,this._cursorManipulatorMaterial=l,this._laserLine=new fs({view:n,attached:!0,style:{glowWidth:Ns,glowFalloff:Zs,innerWidth:Js},isDecoration:!0}),this._updateVisibility(o??!0)}destroy(){this._listenerHandles=V(this._listenerHandles),this._isManipulatorsOwner?this._manipulators=V(this._manipulators):this._manipulators=null,this._laserLine=V(this._laserLine),this._destroyed=!0}get destroyed(){return this._destroyed}get visible(){return this._visible}set visible(e){e?this.show():this.hide()}get testData(){}show(){this._setVisibility(!0)}hide(){this._setVisibility(!1)}_setVisibility(e){this._destroyed||this._visible===e||this._updateVisibility(e)}_updateVisibility(e){this._visible=e,this._laserLine.visible=e,e?(this._initializeListeners(),this._updateAll()):(this._destroyListeners(),this.vertexManipulators.forEach(({manipulator:t})=>this._removeVertexManipulator(t)),this.vertexManipulators=[])}vertexHandleAt(e,t){return this._manipulators.intersect(e,t)?.metadata}pick(e){const t=this._view.spatialReference,i=Ut(e.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const a=this._intersector.results.min,n=g();if(!a.getIntersectionPoint(n))return null;const o=this._view.renderCoordsHelper.fromRenderCoords(n,new K({spatialReference:t}));return o==null?null:new qs(n,o)}_updateAll(){this._visible&&(this._updateVertexManipulators(),this._updateLaserLine())}_createVertexManipulator(){const e=De(this._handleColor),t=[new $e(Ve(e,1,32,32))],i=new be({view:this._view,renderObjects:t});return i.radius=Ge,this._manipulators.add(i),{manipulator:i,material:e}}_removeVertexManipulator(e){this._manipulators.remove(e)}_updateVertexManipulators(){const{viewData:e}=this._analysisViewData,t=this._analysisViewData.path?this._analysisViewData.path.vertices:[],i=this.vertexManipulators;Ks(i,t.length,()=>this._createVertexManipulator(),({manipulator:a})=>this._removeVertexManipulator(a)),i.forEach(({manipulator:a},n)=>{a.metadata=t[n],a.renderLocation=e.positionsRender[n],a.cursor=n===0&&this._toolState.polygonState==="drawing"?"crosshair":null}),this._toolState.polygonState==="drawing"&&this._analysisViewData.stagedPoint!=null?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this._analysisViewData.stagedPoint):this._cursorManipulator.available=!1}get _handleColor(){return Z(this._view.effectiveTheme.accentColor,.5)}_getFocusPoint(){const{lastDraggedVertex:e}=this._analysisViewData;switch(this._toolState.polygonState){case"drawing":return this._analysisViewData.stagedPoint!=null?this._analysisViewData.stagedPoint:e!=null?this._analysisViewData.path.getVertexPositionAsPoint(e):this._analysisViewData.path.lastPoint;case"editing":return e!=null?this._analysisViewData.path.getVertexPositionAsPoint(e):null;default:return this._analysisViewData.stagedPoint}}_updateLaserLine(){const e=this._toolState.polygonState!=="measured"&&this._toolState.active,t=this._getFocusPoint();if(e&&t!=null){const i=this._tempHandlePosition;this._view.renderCoordsHelper.toRenderCoords(t,i),this._laserLine.heightManifoldTarget=i}else this._laserLine.heightManifoldTarget=null}_initializeListeners(){this._listenerHandles=new Wt,this._listenerHandles.add([D(()=>this._toolState.polygonState,()=>this._updateLaserLine()),D(()=>this._analysisViewData.viewData,()=>this._updateAll(),te),D(()=>({lastDraggedVertex:this._analysisViewData.lastDraggedVertex,cursorPoint:this._analysisViewData.stagedPoint}),()=>this._updateLaserLine()),D(()=>this._toolState.active,()=>this._updateAll()),D(()=>this._view.effectiveTheme.accentColor,e=>{const t=Z(e,.5);for(const{material:d}of this.vertexManipulators)d.setParameters({color:t});this._cursorManipulatorMaterial.setParameters({color:t});const i=Me.toUnitRGB(e),a=Me.toUnitRGB(se(e)),n=.75*e.a,o=this._laserLine,l=o.style;o.style={...l,glowColor:i,innerColor:a,globalAlpha:n}},{initial:!0,equals:jt})])}_destroyListeners(){this._listenerHandles=V(this._listenerHandles)}}function Ks(s,e,t,i){for(;s.length<e;)s.push(t());if(i)for(;s.length>e;)i(s.pop());else s.length=e}const Ns=8,Zs=8,Js=1,Ge=5;let w=class extends Vs{constructor(s){super(s),this._updatingHandles=new qt,this._snappingManagerResult=null,this.polygonState="initial",this.removeIncompleteOnCancel=!1,this.manipulators=new qe,this._getSnappingContext=Bt(e=>new Cs({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new ie(new Ee("point",Ue(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new ms}))}initialize(){const{view:s,analysisViewData:e,manipulators:t,visible:i}=this;this.measurementView=new Bs({view:s,analysisViewData:e,toolState:this,manipulators:t,visible:i}),this._snappingOperation=new $s({view:s}),this._updatingHandles.add(()=>this.stagedPoint,a=>{this.analysisViewData.stagedPoint=a!=null?U(a,new K):null},H),os(this,()=>{const a=this.view.inputManager.latestPointerInfo?.type??"mouse",n=this._getSnappingContext(a);this._updatingHandles.addPromise(Se(this._snappingOperation.snapAgainNearPreviousMapPoint(this._ensureSnappingManager(),n)))}),this._setupManipulators(),this.addHandles([Kt(()=>this.state==="measured",()=>this.finishToolCreation(),H),this.analysisViewData.path.on("change",()=>{const a=this.analysisViewData.path;this.polygonState!=="initial"||a.isEmptyPolygon||(a.isValidPolygon?this.polygonState="measured":this.polygonState="drawing")})])}destroy(){this.measurementView.destroy(),this._set("measurementView",null),this._updatingHandles=V(this._updatingHandles)}get _snappingManager(){return this._snappingManagerResult?.snappingManager}_ensureSnappingManager(){if(this._snappingManagerResult==null){const s=Ds(this.view);this._snappingManagerResult=s,this.addHandles(s)}return this._snappingManagerResult.snappingManager}get state(){return this.analysisViewData.path.numVertices===0?"ready":this.analysisViewData.path.isValidPolygon&&this.polygonState!=="editing"?"measured":"measuring"}get cursor(){return this.active?"crosshair":null}get updating(){return this._updatingHandles.updating||!!this._snappingManager?.updating}get stagedPoint(){return this._snappingOperation.stagedPoint}set stagedPoint(s){this._snappingOperation.stagedPoint=s}get snappingOptions(){return this._snappingManager?.options}finishMeasurement(){const{path:s}=this.analysisViewData;s.numVertices<=2||(s.close(),this.polygonState="measured",this._resetSnappingState(),this.active&&(this.view.activeTool=null))}resetCreated(){super.resetCreated(),this._resetSnappingState(),this.polygonState="initial",this.state==="measured"&&(this.polygonState="measured",this.finishToolCreation())}onShow(){this.measurementView.show()}onHide(){this.measurementView.hide()}onDeactivate(){this._resetSnappingState()}onInputEvent(s){switch(s.type){case"immediate-double-click":this._handleImmediateDoubleClick(s);break;case"immediate-click":this._handleImmediateClick(s);break;case"pointer-move":this._handlePointerMove(s);break;case"drag":this._handleDrag(s);break;case"key-down":this._handleKeyDown(s)}}_setupManipulators(){const s=t=>t.events.on("grab-changed",()=>{if(this.analysisViewData.path.isValidPolygon){const i=this.manipulators.some(a=>a.manipulator.grabbing);this.polygonState=i?"editing":"measured"}}),e=t=>{this.addHandles([vs(t,(i,a,n,o)=>{const l=ys(i),d=i.metadata,u=this._snappingManager,p=this._getSnappingContext(o),c=this._updatingHandles,{snappingStep:f,cancelSnapping:_}=Ls({snappingManager:u,snappingContext:p,updatingHandles:c});n=n.next(l).next(v=>(this.analysisViewData.lastDraggedVertex=null,this.analysisViewData.path.setVertexPosition(d,m),i.location=m,v)).next(_),a.next(l).next(_s(this.view)).next(...f).next(v=>{i.location=v.mapEnd,this.analysisViewData.lastDraggedVertex=v.action==="end"?null:d,this.analysisViewData.path.setVertexPosition(d,U(v.mapEnd))});const m=U(this.analysisViewData.path.getVertexPositionAsPoint(d))}),s(t)],t)};this.manipulators.forEach(({manipulator:t})=>{e(t)}),this.addHandles([this.manipulators.on("after-add",({item:{manipulator:t}})=>{e(t)}),this.manipulators.on("after-remove",({item:{manipulator:t}})=>this.removeHandles(t))])}_handleImmediateDoubleClick(s){Ce(s)&&(this.polygonState==="drawing"&&this.finishMeasurement(),s.stopPropagation())}_handleDrag(s){this.polygonState==="editing"&&s.stopPropagation()}_handleImmediateClick(s){if(!Ce(s))return;const e=Pe(s),{pointerType:t}=s;if(this.active)switch(this.polygonState){case"initial":case"measured":if(this._addVertexAt(e,t))return this.stagedPoint=null,this.polygonState="drawing",void s.stopPropagation();break;case"drawing":{const i=this.measurementView.vertexHandleAt(e,t);if(i==null){if(this._addVertexAt(e,t))return this.stagedPoint=null,void s.stopPropagation()}else i.index===0&&(this.finishMeasurement(),s.stopPropagation());break}}s.pointerType==="mouse"&&this._hoverAt(e)}_handlePointerMove(s){if(s.pointerType==="mouse"){const e=Pe(s);this._hoverAt(e)}}_handleKeyDown(s){const{path:e}=this.analysisViewData;s.key===Nt.complete&&this.polygonState==="drawing"&&e.numVertices>=3&&(this.stagedPoint=null,this.finishMeasurement(),s.stopPropagation())}_hoverAt(s){const{polygonState:e}=this;if(this.active&&Qs.has(e)){const t=this._pick(s);if(t?.mapPoint!=null){const i=this._getSnappingContext("mouse");this._updatingHandles.addPromise(Se(this._snappingOperation.snap({point:t.mapPoint},this._ensureSnappingManager(),i)))}}else this.stagedPoint=null}_addVertexAt(s,e){const t=this._pick(s),i=t?.mapPoint;if(i==null)return!1;this.analysis.valid&&this.polygonState==="measured"&&(this.analysis.clear(),this._set("created",!1),this.polygonState="initial");const a=this._getSnappingContext(e),n=this._snappingOperation.update({point:i},this._ensureSnappingManager(),a),o=U(n,new K);return this.analysisViewData.path.add(o),!0}_pick(s){const e=new js(s);return this.measurementView.pick(e)}_resetSnappingState(){this._ensureSnappingManager().doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}get test(){}};r([h()],w.prototype,"_snappingManagerResult",void 0),r([h()],w.prototype,"_snappingManager",null),r([h({readOnly:!0})],w.prototype,"state",null),r([h()],w.prototype,"polygonState",void 0),r([h({readOnly:!0})],w.prototype,"cursor",null),r([h()],w.prototype,"measurementView",void 0),r([h()],w.prototype,"removeIncompleteOnCancel",void 0),r([h({constructOnly:!0})],w.prototype,"view",void 0),r([h({constructOnly:!0})],w.prototype,"analysis",void 0),r([h({constructOnly:!0})],w.prototype,"analysisViewData",void 0),r([h({readOnly:!0})],w.prototype,"manipulators",void 0),r([h()],w.prototype,"updating",null),r([h()],w.prototype,"stagedPoint",null),r([h()],w.prototype,"snappingOptions",null),w=r([T("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],w);const Qs=new Set(["initial","drawing","measured"]);let y=class extends Qt{constructor(s){super(s),this.type="area-measurement-view-3d",this.analysis=null,this.measurementData=null,this.lastDraggedVertex=null,this.stagedPoint=null,this.mode=0,this.tool=null,this.userOperation=null}initialize(){const{analysis:s,view:e}=this;this.path=new L({view:e,areaMeasurement:s}),this._analysisVisualization=new M({view:e,analysis:s,analysisViewData:this}),this.addResolvingPromise(Promise.all([is(),ls()]).then(([t,i])=>{this.destroyed||(this._analysisController=new b({view:e,analysis:s,analysisViewData:this,geodesicAreaMeasurementUtils:t,geodesicLengthMeasurementUtils:i}))})),this.addHandles(Ms(this,w))}destroy(){Ss(this),this.userOperation=Zt(this.userOperation),this._analysisController=V(this._analysisController),this._analysisVisualization=V(this._analysisVisualization),this.path.destroy()}get visible(){return super.visible}set visible(s){super.visible=s}get interactive(){return super.interactive}set interactive(s){super.interactive=s}get updating(){return!!this._analysisVisualization?.loadingMessages}get result(){const{measurementData:s}=this;if(s==null)return{area:null,mode:null,perimeter:null};const{unit:e}=this;if(s.actualMeasurementMode==="euclidean"){const{area:a,perimeterLength:n}=s;return{area:a!=null?ae(a,e):null,perimeter:n!=null?Re(n,e):null,mode:"euclidean"}}const{geodesicArea:t,pathLength:i}=s;return{area:t!=null?ae(t,e):null,perimeter:i!=null?Re(i,e):null,mode:"geodesic"}}get viewData(){return this._analysisVisualization.viewData}get areaLabel(){return this._analysisVisualization.areaLabel}get perimeterLengthLabel(){return this._analysisVisualization.perimeterLengthLabel}get validMeasurement(){return this.path.isValidPolygon}get unit(){return this.analysis.unit??Jt(this.view)}get testData(){}place(s){return Ps(this,{placementOptions:s})}};r([h()],y.prototype,"_analysisVisualization",void 0),r([h()],y.prototype,"_analysisController",void 0),r([h({readOnly:!0})],y.prototype,"type",void 0),r([h({constructOnly:!0,nonNullable:!0})],y.prototype,"analysis",void 0),r([h()],y.prototype,"updating",null),r([h()],y.prototype,"result",null),r([h()],y.prototype,"measurementData",void 0),r([h()],y.prototype,"viewData",null),r([h()],y.prototype,"areaLabel",null),r([h()],y.prototype,"perimeterLengthLabel",null),r([h()],y.prototype,"validMeasurement",null),r([h()],y.prototype,"path",void 0),r([h()],y.prototype,"lastDraggedVertex",void 0),r([h()],y.prototype,"stagedPoint",void 0),r([h()],y.prototype,"mode",void 0),r([h()],y.prototype,"unit",null),r([h()],y.prototype,"tool",void 0),r([h()],y.prototype,"userOperation",void 0),y=r([T("esri.views.3d.analysis.AreaMeasurementAnalysisView3D")],y);const Ei=y,Xs=Object.freeze(Object.defineProperty({__proto__:null,build:Ke},Symbol.toStringTag,{value:"Module"}));export{Ei as default};

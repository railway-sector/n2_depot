import{l9 as K,qW as Q,qX as X,ie as N,qY as ee,qZ as te,q_ as ne,q$ as W,r0 as se,r1 as ae,hG as k,r2 as re,cw as Y,bK as Z,c as j,dF as ie,dG as A,r3 as oe,r4 as le,aU as E,r5 as ce,nU as he,r6 as de,dQ as ue,r7 as _e,au as x,r8 as me,mq as ge,m4 as q,nZ as pe,cI as w,ap as fe,r9 as L,eb as O,s as B,gP as ye,ra as be,rb as ve,rc as Ie,rd as D,cJ as P,re as Ce,rf as R,rg as Se,e as f,m as y,h as De}from"./index-FjkLmFqq.js";class Re extends K{constructor(e,n){super(s=>Q(this._instanceData.view.boundingSphere.getVec(s,Ee)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=n,this._tmpSphere=X(),this._tmpMat4=N()}addInstance(e){const n=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);ee(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*te(s),n.setVec(e,ne(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const Ee=W();class xe{constructor(e,n){this._worldSpaceRadius=e,this._minScreenSpaceRadii=n}selectLevel(e,n,s){const a=s.computeScreenPixelSizeAt(e),o=this._worldSpaceRadius*n/a;let r=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)o>=this._minScreenSpaceRadii[l]&&(r=l);return r}}class we{constructor(e,n){this.geometry=n;const s=e.renderContext.rctx,a=n.renderGeometry,{material:o,layout:r,buffer:l}=a;this._materials=e.materials,o.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new se(o,this._materials),this.vbo=new ae(s,k(r),l),this.vao=new re(s,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,n,s,a,o,r,l,i){return this.geometry.intersect(e,n,s,a,o,r,l,i)}}class M{static async create(e,n,s){const a=await Promise.allSettled(n.components.map(r=>e.controller.schedule(()=>new we(e,r.geometry),s))),o=a.map(r=>r.status==="fulfilled"?r.value:null).filter(Y);if(Z(s)||o.length!==a.length){o.forEach(r=>r.destroy()),j(s);for(const r of a)if(r.status==="rejected")throw r.reason}return new M(n.minScreenSpaceRadius,o)}constructor(e,n){this.minScreenSpaceRadius=e,this.components=n}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,n,s,a,o,r,l){this.components.forEach(i=>i.intersect(e,n,s,a,o,r,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){const e=ie();this.components.forEach(n=>{n.boundingInfo!=null&&(A(e,n.boundingInfo.bbMin),A(e,n.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,n=E();oe(e,n),this._boundingSphere={center:n,radius:.5*le(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,n)=>e+n.numTriangles,0)}}const Le=t=>{const e=t.baseBoundingSphere.radius,n=t.levels.map(s=>s.minScreenSpaceRadius);return new xe(e,n)};let g=class extends ce{constructor(t,e){super(t),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new he,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,n=>this._produces(n)],[4,n=>!!this._hasTransparentLevels()&&this._produces(n)]]),this._instanceData=new de({shaderTransformation:t.shaderTransformation},t.symbol.materialParameters),this.addHandles(e.registerTask(ue.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=_e(this.symbol.materialParameters),this._glInstanceBufferLayout=k(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDatas)e[0]!==x&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDatas.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((n,s)=>n+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((n,s)=>n+s.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((n,s)=>{const a=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,o=n.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:e.reduce((n,s)=>n+s.renderedInstances,0),renderedTriangles:e.reduce((n,s)=>n+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(e=>new me(t,this._instanceBufferLayout))}async initializeRenderContext(t,e){this._context=t,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(a=>M.create(t,a,e))),s=n.map(a=>a.status==="fulfilled"?a.value:null).filter(Y);if(Z(e)||s.length!==n.length){s.forEach(a=>a.destroy()),j(e);for(const a of n)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=Le(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDatas.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return ge(this._highlightRenderInstanceDatas,t=>t.some(e=>e.size>0))}_produces(t){return(t!==9||this.hasHighlights())&&(t!==5||this.hasHighlight(x))}prepareRender(t){if(!q.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(pe),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const n=new Array,s=this.levels;return e.forEach(a=>s.forEach(({components:o},r)=>o.forEach(l=>n.push(this._beginComponent(t,a[r],l))))),n}render(t,e){const n=this._getInstanceDatas(t);if(!n||e==null)return;let s=0;const a=this.levels;n.forEach(o=>a.forEach(({components:r},l)=>r.forEach(i=>this._renderComponent(t,e[s++],o[l],i,l)))),t.rctx.unbindBuffer(34962),t.rctx.bindVAO(null)}_getInstanceDatas(t){const{output:e,bind:n}=t,s=e===9,a=e===5,o=e!==6;if(!s&&!a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:r}=this;if(o){if(s){const i=n.highlight?.name;if(!i)return null;const _=r.get(i);return _?[_]:null}const l=r.get(x);return a?l?[l]:null:Array.from(r.values())}return null}intersect(t,e,n,s){if(!this.baseMaterial.visible||this._octree==null)return;const a=E();w(a,s,n);const o=r=>{this._instanceData.getCombinedModelTransform(r,F),t.transform.set(F),P(H,n,t.transform.inverse),P(G,s,t.transform.inverse);const l=this._instanceData.getState(r),i=this._instanceData.getLodLevel(r),_=this._levels.length;4&l&&(D(!!(18&l),"invalid instance state"),D(i>=0&&i<_,"invaid lod level"),this._levels[i].intersect(t,e,H,G,r,this.metadata,_))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(n,a,o)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new Re(t,this.baseBoundingSphere);for(let n=0;n<t.capacity;++n)18&e.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=fe(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new L;const e=t.viewForward,n=this._octree.findClosest(e,1,t.frustum),s=this._octree.findClosest(e,-1,t.frustum);if(n==null||s==null)return new L;const a=t.eye,o=this._instanceData.view;o.boundingSphere.getVec(n,p),w(p,p,a);const r=O(p,e)-p[3];o.boundingSphere.getVec(s,p),w(p,p,a);const l=O(p,e)+p[3];return new L(r,l)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:n,_levelSelector:s}=this;this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.beginUpdate()));const a=this._instanceData,o=a.view;let r=a.size;const l=a.capacity;let i=this._instanceIndex;const _=Math.ceil(l/500),{_highlightRenderInstanceDatas:u}=this;for(let d=0;d<r&&!t.done;++d){i===this._cycleStartIndex&&this._startUpdateCycle();const c=o.state.get(i);let h=0;if(!(1&c)){i=i+1===l?0:i+1,r++;continue}const I=o.lodLevel.get(i);if(2&c&&this._defaultRenderInstanceData[I].freeTail(),16&c){const m=a.geHighlightOptionsPrev(i);if(m){const b=u.get(m);if(!b)throw new B("internal:lod-renderer","Internal error in lodRenderer");b[I].freeTail(),b.every(S=>S.isEmpty)&&(b.forEach(S=>S.destroy()),u.delete(m))}}if(32&c)a.freeInstance(i);else if(4&c){let m=0;if(e&&(o.modelOrigin.getVec(i,V),m=s.selectLevel(V,a.getCombinedMedianScaleFactor(i),n)),h=-83&c,m>=0)if(8&c){const b=a.getHighlightName(i);if(b){const S=()=>{const T=this._createRenderInstanceDataArray();return T.forEach(J=>J.beginUpdate()),T},$=ye(u,b,S);if(m>=$.length)throw new B("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${m}`);U($[m],o,i)}h|=16}else U(this._defaultRenderInstanceData[m],o,i),h|=2;o.state.set(i,h),o.lodLevel.set(i,m)}else h=-83&c,o.state.set(i,h);const v=!!(18&c),C=!!(18&h);this._octreeCached!=null&&(!v&&C?this._octreeCached.addInstance(i):v&&!C?this._octreeCached.removeInstance(i):v&&C&&64&c&&(this._octreeCached.removeInstance(i),this._octreeCached.addInstance(i))),i=i+1===l?0:i+1,i%_===0&&t.madeProgress(),v!==C&&this.metadata.notifyGraphicVisibilityChanged(i),C&&64&c&&this.metadata.notifyGraphicGeometryChanged(i)}this._instanceIndex=i,this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,n){return e.size===0?null:n.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,n,s,a){if(!e)return;const{bind:o,rctx:r}=t;r.runAppleAmdDriverHelper();const l=r.bindTechnique(e,o,s.material.parameters,$e),i=this._glInstanceBufferLayout;l.assertCompatibleVertexAttributeLocations(s.vao,ve(i)),r.bindVAO(s.vao),q.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===0&&(l.setUniform4fv("externalColor",z[Math.min(a,z.length-1)]),l.setUniform1i("symbolColorMixMode",Ie.replace));const _=n.capacity,u=n.headIndex,d=n.tailIndex,c=n.firstIndex,h=(I,v)=>{Ce(r,l.locations,n.buffer,I),r.drawArraysInstanced(e.primitiveType,0,s.numVertices,v-I)};s.material.transparent&&c!=null?u>d?(D(c>=d&&c<=u,"invalid firstIndex"),h(c,u),h(d,c)):u<d&&(c<=u?(D(c>=0&&c<=u,"invalid firstIndex"),h(c,u),h(d,_),h(0,c)):(D(c>=d&&c<=_,"invalid firstIndex"),h(c,_),h(0,u),h(d,c))):u>d?h(d,u):u<d&&(h(0,u),h(d,_))}};function U(t,e,n){const s=t.allocateHead();Me(e,n,t.view,s)}function Me(t,e,n,s){Se(t.modelOrigin,e,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,t.model,e),n.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&n.color&&n.color.copyFrom(s,t.color,e),t.olidColor&&n.olidColor&&n.olidColor.copyFrom(s,t.olidColor,e),t.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,t.featureAttribute,e)}f([y({constructOnly:!0})],g.prototype,"symbol",void 0),f([y({constructOnly:!0})],g.prototype,"metadata",void 0),f([y({constructOnly:!0})],g.prototype,"shaderTransformation",void 0),f([y()],g.prototype,"_instanceData",void 0),f([y()],g.prototype,"_cycleStartIndex",void 0),f([y({readOnly:!0})],g.prototype,"_enableLevelSelection",null),f([y()],g.prototype,"_updateCyclesWithStaticCamera",void 0),f([y({readOnly:!0})],g.prototype,"readyToRun",null),g=f([De("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],g);const V=E(),p=W(),F=N(),H=E(),G=E(),z=[R(1,0,1,1),R(0,0,1,1),R(0,1,0,1),R(1,1,0,1),R(1,0,0,1)],$e=new be;export{g as F};

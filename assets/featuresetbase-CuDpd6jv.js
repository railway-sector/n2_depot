import{ck as J,e as b,m as v,h as ae,o as Ne,c9 as Te,aC as $e,bx as we,bv as Me,i2 as Re,i1 as Oe,H as Ve,t3 as ze,bl as Ge,i3 as He,hz as y,iC as j,bs as We,iE as A,t4 as _e,dV as Ee,a8 as Be,n5 as Je,ic as Le,bp as P,sH as Ke,ab as Qe}from"./index-FjkLmFqq.js";import{t as qe,l as le}from"./arcade-DpSSloY-.js";import{o as D,w as Ye,m as ue,B as C,p as M,g as k,Z as Xe,c as ve,l as De,X as ke,z as L,T as K,H as te,t as W,L as et,S as Q,Y as tt,a0 as ne}from"./Dictionary-D7MY3x3R.js";import{I as nt}from"./Feature-Cflz326X.js";import{v as it,R as Se,y as rt,h as de,e as ot,i as at,s as st,F as re,E as lt,k as ut,O as dt,a as H,I as ct,D as ie,b as Z,x as ce}from"./featureSetUtils-DJ3QlUw0.js";import{t as ft}from"./ImmutableArray-BPVd6ESQ.js";import{l as mt}from"./portalUtils-Ci0l-2W2.js";import{s as pt,v as xe}from"./SpatialFilter-DPgvY2L1.js";import{N as Ae,o as fe}from"./shared-B-8NJb3k.js";import{L as E}from"./WhereClause-BmMKfyaz.js";import{s as B}from"./NetworkElement--2EEp9g9.js";import"./arcadeEnvironment-8Xt-HvXt.js";import"./aiServices-CpDZe6Kd.js";import"./commonProperties-DHiB1uzW.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-ByBMHVAI.js";import"./number-BtM2O7G6.js";import"./hash-CcEbRgUF.js";import"./operatorsWorkerConnection-CipRoFKJ.js";new J({Clean:"clean",Dirty:"dirty"});new J({Physical:"physical",Virtual:"virtual"});new J({"Start and end":"start-and-end",Start:"start",Midspan:"midspan",End:"end"});new J({startingPoint:"starting-point",barrier:"barrier",stoppingPoint:"stopping-point"});new J({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const Ce="{00000000-0000-0000-0000-000000000000}",R=new J({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new J({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let _=class extends B{constructor(r){super(r),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};b([v({json:{write:!1}})],_.prototype,"type",void 0),b([v({json:{write:!0}})],_.prototype,"firstUnit",void 0),b([v({json:{write:!0}})],_.prototype,"numUnits",void 0),_=b([ae("esri.rest.networks.support.TelecomNetworkElement")],_);let x=class extends we{constructor(u){super(u),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(u,t){return t.fromFirstUnit||t.fromNumUnits?new _({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId,firstUnit:t.fromFirstUnit,numUnits:t.fromNumUnits}):new B({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(u,t){if(u&&(t.fromGlobalId=u.globalId,t.fromNetworkSourceId=u.networkSourceId,t.fromTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const i=u;t.fromFirstUnit=i.firstUnit,t.fromNumUnits=i.numUnits}}readToNetworkElement(u,t){return t.toFirstUnit||t.toNumUnits?new _({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId,firstUnit:t.toFirstUnit,numUnits:t.toNumUnits}):new B({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(u,t){if(u&&(t.toGlobalId=u.globalId,t.toNetworkSourceId=u.networkSourceId,t.toTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const i=u;t.toFirstUnit=i.firstUnit,t.toNumUnits=i.numUnits}}equals(u){if(this.globalId===Ce&&u.globalId===Ce){let t=function(s,p){return s.networkSourceId===p.networkSourceId&&s.globalId===p.globalId&&s.terminalId===p.terminalId&&s.firstUnit===p.firstUnit&&s.numUnits===p.numUnits};const i=this.fromNetworkElement,w=this.toNetworkElement,I=u.fromNetworkElement,e=u.toNetworkElement,n=t(i,I),a=t(w,e);return n&&a&&this.associationType===u.associationType}return this.globalId!=null&&u.globalId!=null&&this.globalId===u.globalId}};b([v({type:String,json:{write:!0}})],x.prototype,"globalId",void 0),b([v({type:R.apiValues,json:{type:R.jsonValues,read:R.read,write:R.write}})],x.prototype,"associationType",void 0),b([v({type:B,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],x.prototype,"fromNetworkElement",void 0),b([Ne("fromNetworkElement")],x.prototype,"readFromNetworkElement",null),b([Te("fromNetworkElement")],x.prototype,"writeFromNetworkElement",null),b([v({type:B,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],x.prototype,"toNetworkElement",void 0),b([Ne("toNetworkElement")],x.prototype,"readToNetworkElement",null),b([Te("toNetworkElement")],x.prototype,"writeToNetworkElement",null),b([v({type:$e,json:{write:!0}})],x.prototype,"geometry",void 0),b([v({type:String,json:{write:!0}})],x.prototype,"errorMessage",void 0),b([v({type:Number,json:{write:!0}})],x.prototype,"percentAlong",void 0),b([v({type:Number,json:{write:!0}})],x.prototype,"errorCode",void 0),b([v({type:Boolean,json:{write:!0}})],x.prototype,"isContentVisible",void 0),b([v({type:Number,json:{write:!0}})],x.prototype,"status",void 0),x=b([ae("esri.rest.networks.support.Association")],x);let oe=class extends we{constructor(u){super(u),this.associations=[]}};b([v({type:[x],json:{write:!0}})],oe.prototype,"associations",void 0),oe=b([ae("esri.rest.networks.support.QueryAssociationsResult")],oe);function yt(r){const{returnDeletes:u,elements:t,gdbVersion:i,moment:w}=r.toJSON();return{returnDeletes:u,elements:JSON.stringify(t.map(I=>({globalId:I.globalId,networkSourceId:I.networkSourceId,terminalId:I.terminalId}))),types:JSON.stringify(r.types.map(I=>R.toJSON(I))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:i,moment:w??Date.now()}}async function wt(r,u,t){const i=Me(r),w={...yt(u),f:"json"},I=Re({...i.query,...w}),e=Oe(I,{...t,method:"post"}),n=`${i.path}/associations/query`,{data:a}=await Ve(n,e),s=oe.fromJSON(a);return u.types.includes("connectivity")&&ze(Ge.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),s}var pe;let z=pe=class extends we{static from(r){return He(pe,r)}constructor(r){super(r),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};b([v({type:Boolean,json:{write:!0}})],z.prototype,"returnDeletes",void 0),b([v({type:[B],json:{write:!0}})],z.prototype,"elements",void 0),b([v({type:[R.apiValues],json:{type:R.jsonValues,read:R.read,write:R.write}})],z.prototype,"types",void 0),b([v({type:String,json:{write:!0}})],z.prototype,"gdbVersion",void 0),b([v({type:Date,json:{type:Number,write:{writer:(r,u)=>{u.moment=r?.getTime()}}}})],z.prototype,"moment",void 0),z=pe=b([ae("esri.rest.networks.support.QueryAssociationsParameters")],z);function It(r){if(r.length===1){if(A(r[0]))return le("distinct",r[0],-1);if(W(r[0]))return le("distinct",r[0].toArray(),-1)}return le("distinct",r,-1)}function me(r,u,t){const i=r.getVariables();if(i.length>0){const w={};for(const I of i)w[I]=u.evaluateIdentifier(t,{name:I});r.parameters=w}return r}function c(r,u,t=null){for(const i in r)if(i.toLowerCase()===u.toLowerCase())return r[i];return t}function Ue(r){if(r===null)return null;const u={type:c(r,"type",""),name:c(r,"name","")};if(u.type==="range")u.range=c(r,"range",[]);else{u.codedValues=[];for(const t of c(r,"codedValues",[]))u.codedValues.push({name:c(t,"name",""),code:c(t,"code",null)})}return u}function ye(r){if(r===null)return null;const u={},t=c(r,"wkt");t!==null&&(u.wkt=t);const i=c(r,"wkid");return i!==null&&(u.wkid=i),u}function je(r){if(r===null)return null;const u={hasZ:c(r,"hasz",!1),hasM:c(r,"hasm",!1)},t=c(r,"spatialreference");t!=null&&(u.spatialReference=ye(t));const i=c(r,"x",null);if(i!==null)return u.x=i,u.y=c(r,"y",null),u.hasZ&&(u.z=c(r,"z",null)),u.hasM&&(u.m=c(r,"m",null)),u;const w=c(r,"rings",null);if(w!==null)return u.rings=w,u;const I=c(r,"paths",null);if(I!==null)return u.paths=I,u;const e=c(r,"points",null);if(e!==null)return u.points=e,u;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=c(r,n,null);a!==null&&(u[n]=a)}return u}function gt(r,u){for(const t of u)if(t===r)return!0;return!1}function ht(r){return!!r.layerDefinition&&!!r.featureSet&&gt(r.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(r.layerDefinition.fields)!==!1&&A(r.featureSet.features)!==!1}function q(r){return r?.toLowerCase()==="utc"?"UTC":r?.toLowerCase()==="unknown"?"Unknown":r}async function bt(r,u,t,i,w,I,e){const n=await r.getFeatureSetInfo();if((n?.layerId??null)===null||!w.layerIdLookup.get(n.layerId))return null;const a=r.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),s=[];switch(t){case"connected":s.push("connectivity"),s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity"),s.push("junction-edge-midspan-connectivity"),s.push("junction-junction-connectivity");break;case"container":case"content":s.push("containment");break;case"structure":case"attached":s.push("attachment");break;case"junctionedge":s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity");break;case"midspan":s.push("junction-edge-midspan-connectivity");break;default:throw new y(I,"InvalidParameter",e)}let p=null,f=!1;if(i!==null&&i!==""&&i!==void 0){for(const d of w.terminals)d.terminalName===i&&(p=d.terminalId);p===null&&(f=!0)}const l=[];if(!f){const d=new B({globalId:u.field(r.globalIdField),networkSourceId:w.layerIdLookup.get(n.layerId).sourceId,...p?{terminalId:p}:""}),m=await wt(a,new z({types:s,elements:[d]}));let S=0;for(const g of m.associations){let h=null,T="",$="";if(g.fromNetworkElement?.globalId===d.globalId?(h=g.toNetworkElement,$="to"):g.toNetworkElement?.globalId===d.globalId&&(h=g.fromNetworkElement,$="from"),!h)continue;switch(t){case"attached":if(g.associationType!=="attachment"||$!=="to")continue;break;case"structure":if(g.associationType!=="attachment"||$!=="from")continue;break;case"container":if(g.associationType!=="containment"||$!=="from")continue;break;case"content":if(g.associationType!=="containment"||$!=="to")continue;break;case"connected":break;case"junctionedge":g.associationType==="junction-edge-to-connectivity"?T="to":g.associationType==="junction-edge-from-connectivity"&&(T="from");break;case"midspan":if(g.associationType!=="junction-edge-midspan-connectivity")continue}const Y=w.sourceIdLookup.get(h.networkSourceId)?.className??"";l.push(new Qe({geometry:null,attributes:{objectId:S++,globalId:h.globalId,percentAlong:g.percentAlong??0,isContentVisible:g.isContentVisible?0:1,className:Y,side:T}}))}}const o=new Le({source:l,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return re(o)}function zt(r){if(r.mode==="async"){r.functions.timezone=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,1,2,t,i),Ye(e[0])||ue(e[0]))return"Unknown";if(C(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?q("unknown"):q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new y(t,"InvalidParameter",i);const s=e[1].field("type");if(j(s)===!1)throw new y(t,"InvalidParameter",i);switch(k(s).toLowerCase()){case"preferredtimezone":return q(e[0].preferredTimeZone);case"editfieldsinfo":return q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&j(e[1].field("fieldname")))return q(e[0].fieldTimeZone(k(e[1].field("fieldname"))))}throw new y(t,"InvalidParameter",i)}const n=Xe(e[0],ve(t));if(n===null)return null;const a=n.timeZone;return a==="system"?We.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},r.functions.sqltimestamp=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{D(e,1,3,t,i);const n=e[0];if(De(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(k(e[1])).toSQLWithKeyword();throw new y(t,"InvalidParameter",i)}if(ue(n))return n.toSQLWithKeyword();if(C(n)){if(e.length!==3)throw new y(t,"InvalidParameter",i);await n.load();const a=k(e[1]);if(ue(e[2]))return e[2].toSQLWithKeyword();if(De(e[2])===!1)throw new y(t,"InvalidParameter",i);const s=n.fieldTimeZone(a);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"sqltimestamp",min:2,max:4}),r.functions.featuresetbyid=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(D(e,2,4,t,i),ke(e[0])){const n=k(e[1]);let a=L(e[2],null);const s=K(L(e[3],!0));if(a===null&&(a=["*"]),A(a)===!1)throw new y(t,"InvalidParameter",i);return e[0].featureSetById(n,s,a)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"featuresetbyid",min:2,max:4});const u=new _e(["datasource","parent","root"]);r.functions.getfeatureset=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,1,2,t,i),te(e[0])){const n=e[1]==null?"datasource":u.lookup(k(e[1]));return it(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"getfeatureset",min:1,max:2}),r.functions.featuresetbyportalitem=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(D(e,2,5,t,i),e[0]===null)throw new y(t,"PortalRequired",i);if(e[0]instanceof qe){const f=k(e[1]),l=k(e[2]);let o=L(e[3],null);const d=K(L(e[4],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new y(t,"InvalidParameter",i);let m;return m=t.services?.portal?t.services.portal:Ee.getDefault(),m=mt(e[0],m),Se(f,l,t.spatialReference,o,d,m,t.lrucache,t.interceptor)}if(j(e[0])===!1)throw new y(t,"PortalRequired",i);const n=k(e[0]),a=k(e[1]);let s=L(e[2],null);const p=K(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(t,"InvalidParameter",i);return Se(n,a,t.spatialReference,s,p,t.services?.portal??Ee.getDefault(),t.lrucache,t.interceptor)})},r.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),r.functions.featuresetbyname=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(D(e,2,4,t,i),ke(e[0])){const n=k(e[1]);let a=L(e[2],null);const s=K(L(e[3],!0));if(a===null&&(a=["*"]),A(a)===!1)throw new y(t,"InvalidParameter",i);return e[0].featureSetByName(n,s,a)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"featuresetbyname",min:2,max:4}),r.functions.featureset=function(t,i){return r.standardFunction(t,i,(w,I,e)=>{D(e,1,1,t,i);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(j(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(n.layerDefinition=a.layerDefinition,n.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(n.featureSet.features=a.features,n.featureSet.geometryType=a.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=a.objectIdFieldName??"",n.layerDefinition.typeIdField=a.typeIdFieldName,n.layerDefinition.globalIdField=a.globalIdFieldName,n.layerDefinition.fields=a.fields,a.spatialReference&&(n.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof M))throw new y(t,"InvalidParameter",i);{const a=JSON.parse(e[0].castToText(!0)),s=c(a,"layerdefinition");if(s!==null){n.layerDefinition.geometryType=c(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=c(s,"globalidfield",""),n.layerDefinition.objectIdField=c(s,"objectidfield",""),n.layerDefinition.typeIdField=c(s,"typeidfield",""),n.layerDefinition.hasZ=c(s,"hasz",!1)===!0,n.layerDefinition.hasM=c(s,"hasm",!1)===!0;const p=c(s,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const f=[];for(const o of c(s,"fields",[])){const d={name:c(o,"name",""),alias:c(o,"alias",""),type:c(o,"type",""),nullable:c(o,"nullable",!0),editable:c(o,"editable",!0),length:c(o,"length",null),domain:Ue(c(o,"domain"))};f.push(d)}n.layerDefinition.fields=f;const l=c(a,"featureset");if(l){const o={};for(const d of f)o[d.name.toLowerCase()]=d.name;for(const d of c(l,"features",[])){const m={},S=c(d,"attributes",{});for(const g in S)m[o[g.toLowerCase()]]=S[g];n.featureSet.features.push({attributes:m,geometry:je(c(d,"geometry"))})}}}else{n.layerDefinition.hasZ=c(a,"hasz",!1)===!0,n.layerDefinition.hasM=c(a,"hasm",!1)===!0,n.layerDefinition.geometryType=c(a,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=c(a,"objectidfieldname",""),n.layerDefinition.typeIdField=c(a,"typeidfieldname","");const p=c(a,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const f=[],l=c(a,"fields",null);if(!A(l))throw new y(t,"InvalidParameter",i);for(const m of l){const S={name:c(m,"name",""),alias:c(m,"alias",""),type:c(m,"type",""),nullable:c(m,"nullable",!0),editable:c(m,"editable",!0),length:c(m,"length",null),domain:Ue(c(m,"domain"))};f.push(S)}n.layerDefinition.fields=f;const o={};for(const m of f)o[m.name.toLowerCase()]=m.name;let d=c(a,"features",null);if(A(d))for(const m of d){const S={},g=c(m,"attributes",{});for(const h in g)S[o[h.toLowerCase()]]=g[h];n.featureSet.features.push({attributes:S,geometry:je(c(m,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(ht(n)===!1)throw new y(t,"InvalidParameter",i);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),rt.create(n,t.spatialReference)})},r.signatures.push({name:"featureset",min:1,max:1}),r.functions.filter=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,2,2,t,i),A(e[0])||W(e[0])){const n=[];let a,s=e[0];if(s instanceof ft&&(s=s.toArray()),!et(e[1]))throw new y(t,"InvalidParameter",i);a=e[1].createFunction(t);for(const p of s){const f=a(p);Be(f)?await f===!0&&n.push(p):f===!0&&n.push(p)}return n}if(C(e[0])){const n=await e[0].load(),a=E.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=a.getVariables();if(s.length>0){const p={};for(const f of s)p[f]=r.evaluateIdentifier(t,{name:f});a.parameters=p}return new de({parentfeatureset:e[0],whereclause:a})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"filter",min:2,max:2}),r.functions.orderby=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,2,2,t,i),C(e[0])){const n=new ot(e[1]);return new at({parentfeatureset:e[0],orderbyclause:n})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"orderby",min:2,max:2}),r.functions.top=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,2,2,t,i),C(e[0]))return new st({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return Q(e[1])>=e[0].length?e[0].slice():e[0].slice(0,Q(e[1]));if(W(e[0]))return Q(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,Q(e[1]));throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"top",min:2,max:2}),r.functions.first=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,1,1,t,i),C(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const a=nt.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return A(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},r.signatures.push({name:"first",min:1,max:1}),r.functions.attachments=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{D(e,1,2,t,i);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(n.minsize=Q(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=K(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=Q(e[1].field("maxsize"))),e[1].hasField("types")){const a=tt(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new y(t,"InvalidParameter",i)}if(te(e[0])){const a=e[0]._layer;let s;if(C(a))s=a;else{if(a==null||!Ae(a))return[];s=re(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"attachments",min:1,max:2}),r.functions.featuresetbyrelationshipname=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{D(e,2,4,t,i);const n=e[0],a=k(e[1]);let s=L(e[2],null);const p=K(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(t,"InvalidParameter",i);if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",i);const f=n._layer;let l;if(C(f))l=f;else{if(f==null||!Ae(f))return null;l=re(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}l=await l.load();const o=l.relationshipMetaData().filter(h=>h.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return lt(l,o[0],n.field(l.objectIdField),l.spatialReference,s,p,t.lrucache,t.interceptor);let d=l.serviceUrl();if(!d)return null;d=d.endsWith("/")?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const m=await ut(d,l.spatialReference,s,p,t.lrucache,t.interceptor);await m.load();let S=m.relationshipMetaData();if(S=S.filter(h=>h.id===o[0].id),n.hasField(o[0].keyField)===!1||n.field(o[0].keyField)===null){const h=await l.getFeatureByObjectId(n.field(l.objectIdField),[o[0].keyField]);if(h){const T=E.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:h.attributes[o[0].keyField]},m.filter(T)}return new pt({parentfeatureset:m})}const g=E.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:n.field(o[0].keyField)},m.filter(g)})},r.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),r.functions.featuresetbyassociation=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{D(e,2,3,t,i);const n=e[0],a=Je(k(L(e[1],""))),s=j(e[2])?k(e[2]):null;if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",i);let p=n._layer;if(p instanceof Le&&(p=re(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||C(p)===!1)return null;await p.load();const f=p.serviceUrl(),l=await dt(f,t.spatialReference,!0);if(l.unVersion>=8)return await bt(p,n,a,s,l,t,i);const o=l.associations;let d=null,m=null,S=!1;if(s!==null&&s!==""&&s!==void 0){for(const N of l.terminals)N.terminalName===s&&(m=N.terminalId);m===null&&(S=!0)}const g=o.getFieldsIndex(),h=g.get("TOGLOBALID").name,T=g.get("FROMGLOBALID").name,$=g.get("TOTERMINALID").name,Y=g.get("FROMTERMINALID").name,X=g.get("FROMNETWORKSOURCEID").name,ee=g.get("TONETWORKSOURCEID").name,G=g.get("ASSOCIATIONTYPE").name,Ze=g.get("ISCONTENTVISIBLE").name,Pe=g.get("OBJECTID").name;for(const N of p.fields)if(N.type==="global-id"){d=n.field(N.name);break}let O=null,Ie=new H(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new H(new P({name:"side",alias:"side",type:"string"}),E.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const U="globalid",he="globalId",be={};for(const N in l.lkp)be[N]=l.lkp[N].sourceId;const V=new ct(new P({name:"classname",alias:"classname",type:"string"}),null,be);let F="";switch(a){case"midspan":{F=`((${h}='${d}') OR ( ${T}='${d}')) AND (${G} IN (5))`,V.codefield=E.create(`CASE WHEN (${h}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=fe(Z.findField(o.fields,T));N.name=U,N.alias=U,O=new H(N,E.create(`CASE WHEN (${T}='${d}') THEN ${h} ELSE ${T} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=l.unVersion>=4?new ce(Z.findField(o.fields,g.get("PERCENTALONG").name)):new H(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${h}='${d}') OR ( ${T}='${d}')) AND (${G} IN (4,6))`,V.codefield=E.create(`CASE WHEN (${h}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=fe(Z.findField(o.fields,T));N.name=U,N.alias=U,O=new H(N,E.create(`CASE WHEN (${T}='${d}') THEN ${h} ELSE ${T} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new H(new P({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${G}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let N=`${h}='@T'`,Fe=`${T}='@T'`;m!==null&&(N+=` AND ${$}=@A`,Fe+=` AND ${Y}=@A`),F="(("+N+") OR ("+Fe+"))",F=ne(F,"@T",d??""),N=ne(N,"@T",d??""),m!==null&&(N=ne(N,"@A",m.toString()),F=ne(F,"@A",m.toString())),V.codefield=E.create("CASE WHEN "+N+` THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const se=fe(Z.findField(o.fields,T));se.name=U,se.alias=U,O=new H(se,E.create("CASE WHEN "+N+` THEN ${T} ELSE ${h} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${h}='${d}' AND ${G} = 2`,m!==null&&(F+=` AND ${$} = `+m.toString()),V.codefield=X,F="( "+F+" )",O=new ie(Z.findField(o.fields,T),U,U);break;case"content":F=`(${T}='${d}' AND ${G} = 2)`,m!==null&&(F+=` AND ${Y} = `+m.toString()),V.codefield=ee,F="( "+F+" )",O=new ie(Z.findField(o.fields,h),U,U);break;case"structure":F=`(${h}='${d}' AND ${G} = 3)`,m!==null&&(F+=` AND ${$} = `+m.toString()),V.codefield=X,F="( "+F+" )",O=new ie(Z.findField(o.fields,T),U,he);break;case"attached":F=`(${T}='${d}' AND ${G} = 3)`,m!==null&&(F+=` AND ${Y} = `+m.toString()),V.codefield=ee,F="( "+F+" )",O=new ie(Z.findField(o.fields,h),U,he);break;default:throw new y(t,"InvalidParameter",i)}return S&&(F="1 <> 1"),new Z({parentfeatureset:o,adaptedFields:[new ce(Z.findField(o.fields,Pe)),new ce(Z.findField(o.fields,Ze)),O,ge,V,Ie],extraFilter:F?E.create(F,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},r.signatures.push({name:"featuresetbyassociation",min:2,max:6}),r.functions.groupby=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,3,3,t,i),!C(e[0]))throw new y(t,"InvalidParameter",i);const n=await e[0].load(),a=[],s=[];let p=!1,f=[];if(j(e[1]))f.push(e[1]);else if(e[1]instanceof M)f.push(e[1]);else if(A(e[1]))f=e[1];else{if(!W(e[1]))throw new y(t,"InvalidParameter",i);f=e[1].toArray()}for(const l of f)if(j(l)){const o=E.create(k(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=xe(o)===!0?k(l):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof M))throw new y(t,"InvalidParameter",i);{const o=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",d=l.hasField("expression")?l.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new y(t,"InvalidParameter",i);a.push({name:o,expression:E.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],j(e[2]))f.push(e[2]);else if(A(e[2]))f=e[2];else if(W(e[2]))f=e[2].toArray();else{if(!(e[2]instanceof M))throw new y(t,"InvalidParameter",i);f.push(e[2])}for(const l of f){if(!(l instanceof M))throw new y(t,"InvalidParameter",i);{const o=l.hasField("name")?l.field("name"):"",d=l.hasField("statistic")?l.field("statistic"):"",m=l.hasField("expression")?l.field("expression"):"";if(!(o&&d&&j(d)&&m))throw new y(t,"InvalidParameter",i);s.push({name:o,statistic:d,expression:E.create(m,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const l={};for(const d of n.fields)l[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);for(const d of s)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;l["field_"+o.toString()]===1;)o++;l["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const l of a)me(l.expression,r,t);for(const l of s)me(l.expression,r,t);return e[0].groupby(a,s)})},r.signatures.push({name:"groupby",min:3,max:3}),r.functions.distinct=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(C(e[0])){D(e,2,2,t,i);const n=await e[0].load(),a=[];let s=[];if(j(e[1]))s.push(e[1]);else if(e[1]instanceof M)s.push(e[1]);else if(A(e[1]))s=e[1];else{if(!W(e[1]))throw new y(t,"InvalidParameter",i);s=e[1].toArray()}let p=!1;for(const f of s)if(j(f)){const l=E.create(k(f),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=xe(l)===!0?k(f):"%%%%FIELDNAME";a.push({name:o,expression:l}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(f instanceof M))throw new y(t,"InvalidParameter",i);{const l=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",o=f.hasField("expression")?f.field("expression"):"";if(l==="%%%%FIELDNAME"&&(p=!0),!l)throw new y(t,"InvalidParameter",i);a.push({name:l,expression:E.create(o||l,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const f={};for(const o of n.fields)f[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(f[o.name.toLowerCase()]=1);let l=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;f["field_"+l.toString()]===1;)l++;f["field_"+l.toString()]=1,o.name="FIELD_"+l.toString()}}for(const f of a)me(f.expression,r,t);return e[0].groupby(a,[])}return It(e)})},r.functions.getfeaturesetinfo=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,1,1,t,i),!C(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?M.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},ve(t),!1,!1):null})},r.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),r.functions.filterbysubtypecode=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(D(e,2,2,t,i),C(e[0])){const n=await e[0].load(),a=e[1];if(!Ke(a))throw new y(t,"InvalidParameter",i);if(n.subtypeField){const p=E.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new y(t,"FeatureSetDoesNotHaveSubtypes",i);const s=E.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:s})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{zt as registerFunctions};
